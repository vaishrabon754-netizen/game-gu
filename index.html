<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CURSED APARTMENT - Mobile Horror Escape Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">
<style>
    /* RESET AND BASE */
    * {
        margin: 0; 
        padding: 0; 
        box-sizing: border-box; 
        -webkit-touch-callout: none; 
        -webkit-user-select: none; 
        -moz-user-select: none; 
        -ms-user-select: none; 
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }
    
    body, html {
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #000;
        font-family: 'Courier New', monospace;
        color: #e8d8c0;
        position: fixed;
    }
    
    /* CANVAS - FULLSCREEN */
    #gameCanvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
        display: block;
        image-rendering: pixelated;
        image-rendering: crisp-edges;
    }
    
    /* SCREENS - ALWAYS FULLSCREEN */
    .screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        padding: 15px;
        overflow: hidden;
    }
    
    #startScreen {
        display: flex;
        background: radial-gradient(ellipse at center, #111122 0%, #000000 100%);
    }
    
    #modeScreen {
        display: none;
        background: linear-gradient(135deg, #0a0a1a 0%, #000000 100%);
    }
    
    #gameScreen {
        display: none;
        background: transparent;
        pointer-events: none;
    }
    
    #winScreen, #gameoverScreen {
        display: none;
        background: radial-gradient(circle at center, rgba(20, 0, 20, 0.9), #000 70%);
    }
    
    /* SCREEN CONTENT */
    .screen h1 {
        font-size: 2.8rem;
        text-shadow: 0 0 25px #ff0040, 0 0 8px #800020;
        margin-bottom: 25px;
        text-align: center;
        letter-spacing: 3px;
        color: #ffd0d0;
        font-weight: normal;
        background: linear-gradient(45deg, #ffd0d0, #ff8080);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        position: relative;
    }
    
    .screen h1::after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 180px;
        height: 3px;
        background: linear-gradient(90deg, transparent, #ff0040, transparent);
    }
    
    .btn {
        background: linear-gradient(145deg, #5a0000, #3a0000);
        color: #ffd0d0;
        border: 2px solid #a00000;
        border-radius: 8px;
        padding: 14px 25px;
        font-size: 1.2rem;
        margin: 10px;
        cursor: pointer;
        box-shadow: 0 5px 15px rgba(160, 0, 0, 0.4), 
                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
        width: 90%;
        max-width: 250px;
        text-align: center;
        font-family: 'Courier New', monospace;
        letter-spacing: 1px;
        transition: all 0.2s;
        position: relative;
        overflow: hidden;
    }
    
    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transition: left 0.5s;
    }
    
    .btn:active {
        background: linear-gradient(145deg, #7a0000, #5a0000);
        transform: translateY(2px);
        box-shadow: 0 2px 8px rgba(160, 0, 0, 0.4);
    }
    
    .btn:active::before {
        left: 100%;
    }
    
    .mode-btn {
        background: linear-gradient(145deg, #003322, #002211);
        border-color: #006644;
        box-shadow: 0 5px 15px rgba(0, 100, 68, 0.4);
    }
    
    .easy { 
        background: linear-gradient(145deg, #003322, #002211);
        border-color: #00aa66;
    }
    
    .normal { 
        background: linear-gradient(145deg, #333322, #222211);
        border-color: #aaaa00;
    }
    
    .hard { 
        background: linear-gradient(145deg, #553322, #332211);
        border-color: #ff6600;
    }
    
    .impossible { 
        background: linear-gradient(145deg, #550000, #330000);
        border-color: #ff0000;
    }
    
    /* GAME VISUAL EFFECTS */
    #torch {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle 450px at var(--x,50%) var(--y,50%), 
                    rgba(255, 200, 100, 0.6) 0%, 
                    rgba(180, 120, 60, 0.3) 20%, 
                    rgba(80, 40, 20, 0.1) 40%, 
                    transparent 70%);
        opacity: 0;
        pointer-events: none;
        z-index: 2;
        mix-blend-mode: plus-lighter;
        transition: opacity 0.3s;
    }
    
    #torch-beam {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: conic-gradient(from var(--angle, 0deg) at var(--x,50%) var(--y,50%), 
                    rgba(255, 220, 150, 0.4) 0deg,
                    rgba(255, 200, 100, 0.3) 30deg,
                    rgba(180, 120, 60, 0.2) 60deg,
                    transparent 90deg);
        opacity: 0;
        pointer-events: none;
        z-index: 1;
        mix-blend-mode: plus-lighter;
        transition: opacity 0.3s;
    }
    
    #darkness {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        pointer-events: none;
        z-index: 3;
        transition: opacity 1s;
    }
    
    #vignette {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(ellipse at center, 
                    transparent 40%, 
                    rgba(0, 0, 0, 0.8) 80%);
        pointer-events: none;
        z-index: 4;
    }
    
    #blood {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at var(--blood-x,50%) var(--blood-y,50%), 
                    rgba(200, 0, 0, 0.8) 0%, 
                    rgba(120, 0, 0, 0.4) 15%, 
                    transparent 30%);
        opacity: 0;
        pointer-events: none;
        z-index: 5;
        mix-blend-mode: multiply;
        transition: opacity 0.5s;
    }
    
    #hideText {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 36px;
        color: #600;
        text-shadow: 0 0 20px #f00, 0 0 5px #000;
        opacity: 0;
        z-index: 999;
        letter-spacing: 6px;
        font-weight: bold;
        font-family: 'Courier New', monospace;
        transition: opacity 0.3s;
    }
    
    #prompt {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(30, 0, 0, 0.85);
        border: 2px solid #a00000;
        border-radius: 8px;
        padding: 10px 20px;
        font-size: 16px;
        color: #ffd0d0;
        z-index: 999;
        display: none;
        text-align: center;
        max-width: 85%;
        backdrop-filter: blur(5px);
        box-shadow: 0 0 20px rgba(160, 0, 0, 0.5);
        font-family: 'Courier New', monospace;
        transition: opacity 0.3s;
    }
    
    /* MOBILE CONTROLS */
    #controls {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 900;
        pointer-events: none;
        touch-action: none;
    }
    
    /* HEALTH BAR - TOP */
    #healthBar {
        position: absolute;
        top: 12px;
        left: 12px;
        right: 12px;
        height: 20px;
        background: rgba(10, 0, 0, 0.7);
        border: 2px solid #a00000;
        border-radius: 4px;
        overflow: hidden;
        backdrop-filter: blur(4px);
    }
    
    #healthFill {
        height: 100%;
        background: linear-gradient(90deg, 
                    #00ff00 0%, 
                    #aaff00 33%, 
                    #ffff00 66%, 
                    #ff0000 100%);
        width: 100%;
        transition: width 0.3s ease;
    }
    
    #healthText {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #fff;
        font-weight: bold;
        font-size: 10px;
        text-shadow: 1px 1px 2px #000;
        font-family: 'Courier New', monospace;
        letter-spacing: 0.5px;
    }
    
    /* BATTERY BAR */
    #batteryBar {
        position: absolute;
        top: 40px;
        left: 12px;
        right: 12px;
        height: 12px;
        background: rgba(0, 10, 0, 0.7);
        border: 1px solid #00a000;
        border-radius: 3px;
        overflow: hidden;
        backdrop-filter: blur(4px);
    }
    
    #batteryFill {
        height: 100%;
        background: linear-gradient(90deg, 
                    #00ff00 0%, 
                    #ffff00 50%, 
                    #ff0000 100%);
        width: 100%;
        transition: width 0.3s ease;
    }
    
    /* CAR HEALTH BAR (GARAGE SCENE) */
    #carHealthBar {
        position: absolute;
        top: 55px;
        left: 12px;
        right: 12px;
        height: 12px;
        background: rgba(10, 10, 0, 0.7);
        border: 1px solid #a0a000;
        border-radius: 3px;
        overflow: hidden;
        backdrop-filter: blur(4px);
        display: none;
    }
    
    #carHealthFill {
        height: 100%;
        background: linear-gradient(90deg, 
                    #00ff00 0%, 
                    #ffff00 50%, 
                    #ff0000 100%);
        width: 100%;
        transition: width 0.3s ease;
    }
    
    #carHealthText {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #fff;
        font-weight: bold;
        font-size: 8px;
        text-shadow: 1px 1px 2px #000;
        font-family: 'Courier New', monospace;
    }
    
    /* JOYSTICK - LEFT BOTTOM */
    #joystickArea {
        position: absolute;
        bottom: 15px;
        left: 15px;
        width: 100px;
        height: 100px;
        pointer-events: auto;
        z-index: 901;
    }
    
    #joystickBase {
        width: 100%;
        height: 100%;
        background: rgba(20, 0, 0, 0.6);
        border: 2px solid #600;
        border-radius: 50%;
        backdrop-filter: blur(5px);
    }
    
    #joystick {
        position: absolute;
        width: 45px;
        height: 45px;
        background: rgba(180, 0, 0, 0.8);
        border: 2px solid #c00;
        border-radius: 50%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        box-shadow: 0 0 15px rgba(200, 0, 0, 0.5);
    }
    
    /* ACTION BUTTONS - RIGHT SIDE */
    #actionBtn {
        position: absolute;
        bottom: 15px;
        right: 15px;
        width: 65px;
        height: 65px;
        background: rgba(30, 0, 30, 0.7);
        border: 3px solid #a000a0;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #ffd0d0;
        font-size: 20px;
        font-weight: bold;
        box-shadow: 0 5px 15px rgba(160, 0, 160, 0.4);
        backdrop-filter: blur(5px);
        font-family: 'Courier New', monospace;
        pointer-events: auto;
        z-index: 901;
    }
    
    #actionBtn:active {
        background: rgba(200, 0, 200, 0.9);
        transform: scale(0.9);
    }
    
    /* SHOOT BUTTON */
    #shootBtn {
        position: absolute;
        bottom: 90px;
        right: 15px;
        width: 65px;
        height: 65px;
        background: rgba(180, 0, 0, 0.7);
        border: 3px solid #c00;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #ffd0d0;
        font-size: 22px;
        pointer-events: auto;
        z-index: 901;
        box-shadow: 0 5px 20px rgba(200, 0, 0, 0.5);
        backdrop-filter: blur(5px);
    }
    
    #shootBtn:active {
        background: rgba(255, 50, 50, 0.9);
        transform: scale(0.9);
    }
    
    /* FLASHLIGHT TOGGLE */
    #flashlightBtn {
        position: absolute;
        top: 75px;
        right: 12px;
        width: 45px;
        height: 45px;
        background: rgba(40, 40, 0, 0.6);
        border: 2px solid #cc0;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #ff0;
        font-size: 18px;
        pointer-events: auto;
        z-index: 901;
        box-shadow: 0 5px 15px rgba(204, 204, 0, 0.4);
        backdrop-filter: blur(5px);
    }
    
    #flashlightBtn:active {
        background: rgba(80, 80, 0, 0.9);
        transform: scale(0.9);
    }
    
    /* INVENTORY BUTTON */
    #inventoryBtn {
        position: absolute;
        top: 130px;
        right: 12px;
        width: 45px;
        height: 45px;
        background: rgba(0, 40, 40, 0.6);
        border: 2px solid #0cc;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #0ff;
        font-size: 18px;
        pointer-events: auto;
        z-index: 901;
        box-shadow: 0 5px 15px rgba(0, 204, 204, 0.4);
        backdrop-filter: blur(5px);
    }
    
    #inventoryBtn:active {
        background: rgba(0, 80, 80, 0.9);
        transform: scale(0.9);
    }
    
    /* FLOOR INDICATOR */
    #floorIndicator {
        position: absolute;
        top: 40px;
        left: 12px;
        background: rgba(10, 0, 10, 0.7);
        border: 2px solid #a000a0;
        border-radius: 6px;
        padding: 4px 8px;
        color: #f0c0f0;
        font-size: 12px;
        font-weight: bold;
        z-index: 902;
        backdrop-filter: blur(4px);
        font-family: 'Courier New', monospace;
    }
    
    /* QUIT BUTTON */
    #quitBtn {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 45px;
        height: 45px;
        background: rgba(40, 0, 0, 0.7);
        border: 2px solid #c00;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #ffd0d0;
        font-size: 18px;
        pointer-events: auto;
        z-index: 902;
        box-shadow: 0 5px 15px rgba(200, 0, 0, 0.4);
        backdrop-filter: blur(5px);
    }
    
    #quitBtn:active {
        background: rgba(200, 0, 0, 0.9);
        transform: scale(0.9);
    }
    
    /* INVENTORY PANEL */
    #inventoryPanel {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 400px;
        max-height: 80%;
        background: rgba(10, 0, 10, 0.95);
        border: 3px solid #a000a0;
        border-radius: 12px;
        padding: 15px;
        z-index: 10000;
        display: none;
        backdrop-filter: blur(10px);
        box-shadow: 0 0 40px rgba(160, 0, 160, 0.6);
        overflow-y: auto;
    }
    
    .inventory-item {
        background: rgba(30, 0, 30, 0.7);
        border: 2px solid #a000a0;
        border-radius: 8px;
        padding: 10px;
        margin: 8px 0;
        display: flex;
        align-items: center;
        gap: 12px;
        color: #ffd0d0;
        font-size: 14px;
    }
    
    .item-icon {
        font-size: 24px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(80, 0, 80, 0.5);
        border-radius: 6px;
    }
    
    .item-info {
        flex: 1;
    }
    
    .item-name {
        font-weight: bold;
        margin-bottom: 4px;
    }
    
    .item-description {
        font-size: 12px;
        color: #c0a0c0;
    }
    
    .use-btn {
        background: #a000a0;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 6px 12px;
        font-size: 12px;
        cursor: pointer;
    }
    
    .use-btn:active {
        background: #c000c0;
    }
    
    /* MODALS */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        z-index: 10000;
        display: none;
        justify-content: center;
        align-items: center;
        padding: 15px;
    }
    
    .modal-content {
        background: linear-gradient(145deg, #1a001a, #0a000a);
        padding: 20px;
        border-radius: 12px;
        border: 3px solid #a000a0;
        text-align: center;
        max-width: 95%;
        width: 380px;
        box-shadow: 0 0 40px rgba(160, 0, 160, 0.6);
        position: relative;
        overflow: hidden;
    }
    
    .modal-content::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, transparent, #ff00ff, transparent);
    }
    
    /* RESPONSIVE */
    @media (max-width: 480px) {
        .screen h1 {
            font-size: 2.2rem;
        }
        
        .btn {
            font-size: 1rem;
            padding: 12px 18px;
            max-width: 220px;
            margin: 8px;
        }
        
        #joystickArea {
            width: 90px;
            height: 90px;
            bottom: 12px;
            left: 12px;
        }
        
        #joystick {
            width: 40px;
            height: 40px;
        }
        
        #actionBtn {
            width: 60px;
            height: 60px;
            font-size: 18px;
            bottom: 12px;
            right: 12px;
        }
        
        #shootBtn {
            width: 60px;
            height: 60px;
            bottom: 85px;
            right: 12px;
            font-size: 20px;
        }
        
        #flashlightBtn {
            width: 40px;
            height: 40px;
            font-size: 16px;
            top: 70px;
            right: 10px;
        }
        
        #inventoryBtn {
            width: 40px;
            height: 40px;
            font-size: 16px;
            top: 125px;
            right: 10px;
        }
        
        #quitBtn {
            width: 40px;
            height: 40px;
            font-size: 16px;
            top: 10px;
            right: 10px;
        }
        
        #healthBar {
            height: 18px;
            top: 10px;
            left: 10px;
            right: 10px;
        }
        
        #batteryBar {
            top: 35px;
            left: 10px;
            right: 10px;
            height: 10px;
        }
        
        #carHealthBar {
            top: 50px;
            left: 10px;
            right: 10px;
            height: 10px;
        }
        
        #healthText {
            font-size: 9px;
        }
        
        #floorIndicator {
            top: 35px;
            left: 10px;
            font-size: 11px;
            padding: 3px 6px;
        }
        
        #hideText {
            font-size: 32px;
        }
        
        #prompt {
            font-size: 14px;
            padding: 8px 16px;
        }
        
        .modal-content {
            padding: 12px;
            width: 340px;
        }
    }
    
    @media (min-width: 768px) and (orientation: landscape) {
        #joystickArea {
            width: 95px;
            height: 95px;
        }
        
        #joystick {
            width: 42px;
            height: 42px;
        }
        
        #actionBtn, #shootBtn {
            width: 60px;
            height: 60px;
        }
        
        #flashlightBtn, #inventoryBtn, #quitBtn {
            width: 45px;
            height: 45px;
        }
    }
</style>
</head>
<body>
<!-- SCREENS -->
<div id="startScreen" class="screen">
    <h1>CURSED APARTMENT</h1>
    
    <div style="font-size: 0.9rem; text-align: center; margin: 12px; background: rgba(30, 0, 30, 0.6); padding: 12px; border-radius: 8px; border: 1px solid #600060; max-width: 90%;">
        <div style="color: #a0f0ff; font-weight: bold; margin-bottom: 6px; font-size: 1rem;">üéØ 3 WAYS TO ESCAPE: CAR, HELICOPTER, MAIN DOOR!</div>
        <div style="margin: 5px 0;"><span style="color: #0f0">JOYSTICK:</span> MOVE</div>
        <div style="margin: 5px 0;"><span style="color: #f80">üî´ BUTTON:</span> SHOOT</div>
        <div style="margin: 5px 0;"><span style="color: #ff0">A BUTTON:</span> INTERACT/HIDE</div>
        <div style="margin: 5px 0;"><span style="color: #cc0">üî¶ ICON:</span> FLASHLIGHT (FLOOR 1)</div>
        <div style="margin: 5px 0;"><span style="color: #0ff">üì¶ ICON:</span> INVENTORY</div>
        <div style="margin-top: 8px; color: #ff8080; font-size: 0.85rem;">20 Puzzles ‚Ä¢ Garage on Floor 1 ‚Ä¢ Rope for Roof ‚Ä¢ Big Monster!</div>
    </div>
    
    <button class="btn" id="startBtn">SELECT MODE</button>
</div>

<div id="modeScreen" class="screen">
    <h1>SELECT DIFFICULTY</h1>
    <button class="btn mode-btn easy" data-mode="easy">EASY</button>
    <button class="btn mode-btn normal" data-mode="normal">NORMAL</button>
    <button class="btn mode-btn hard" data-mode="hard">HARD</button>
    <button class="btn mode-btn impossible" data-mode="impossible">IMPOSSIBLE</button>
    <button class="btn" id="backBtn">BACK</button>
</div>

<div id="gameScreen" class="screen"></div>

<div id="winScreen" class="screen">
    <h1 id="winTitle">ESCAPE SUCCESS!</h1>
    <p id="winText" style="font-size: 1.3rem; margin: 15px; text-align: center; color: #a0ffa0;"></p>
    <button class="btn" onclick="location.reload()">PLAY AGAIN</button>
</div>

<div id="gameoverScreen" class="screen">
    <h1>YOU DIED</h1>
    <p style="font-size: 1.3rem; margin: 15px; text-align: center; color: #ffa0a0;">The darkness consumed you...</p>
    <button class="btn" onclick="location.reload()">TRY AGAIN</button>
</div>

<!-- CANVAS -->
<canvas id="gameCanvas"></canvas>

<!-- GAME EFFECTS -->
<div id="torch"></div>
<div id="torch-beam"></div>
<div id="darkness"></div>
<div id="vignette"></div>
<div id="blood"></div>
<div id="hideText">HIDING...</div>
<div id="prompt"></div>

<!-- MOBILE CONTROLS -->
<div id="controls">
    <div id="healthBar">
        <div id="healthFill"></div>
        <div id="healthText">HP: 100 | KEYS: 0/5 | BULLETS: 10</div>
    </div>
    
    <div id="batteryBar">
        <div id="batteryFill"></div>
    </div>
    
    <div id="carHealthBar">
        <div id="carHealthFill"></div>
        <div id="carHealthText">CAR HP: 100%</div>
    </div>
    
    <div id="floorIndicator">FLOOR: 1</div>
    
    <div id="quitBtn">‚ùå</div>
    
    <div id="joystickArea">
        <div id="joystickBase"></div>
        <div id="joystick"></div>
    </div>
    
    <div id="shootBtn">üî´</div>
    
    <div id="actionBtn">A</div>
    
    <div id="flashlightBtn">üî¶</div>
    
    <div id="inventoryBtn">üì¶</div>
</div>

<!-- INVENTORY PANEL -->
<div id="inventoryPanel">
    <h2 style="color: #f99; margin-bottom: 15px; font-size: 1.6rem; text-align: center;">INVENTORY</h2>
    <div id="inventoryItems"></div>
    <button onclick="closeInventory()" class="btn" style="width: 100%; margin-top: 15px; font-size: 1rem;">CLOSE</button>
</div>

<!-- MODALS -->
<div id="puzzleModal" class="modal">
    <div class="modal-content">
        <h2 style="color: #f99; margin-bottom: 12px; font-size: 1.6rem;">SOLVE PUZZLE</h2>
        <p id="puzzleQuestion" style="font-size: 1.4rem; color: #0ff; margin: 12px 0; min-height: 50px; display: flex; align-items: center; justify-content: center;"></p>
        <input type="text" id="puzzleAnswer" style="width: 100%; padding: 8px; font-size: 1.1rem; text-align: center; background: #111; color: #fff; border: 2px solid #600; border-radius: 6px; margin: 8px 0;" placeholder="Enter answer...">
        <div style="display: flex; gap: 6px; margin-top: 12px;">
            <button id="submitPuzzle" class="btn" style="flex: 1; padding: 8px; font-size: 1rem;">SUBMIT</button>
            <button onclick="closePuzzle()" class="btn" style="background: #400; border-color: #600; padding: 8px; font-size: 1rem;">CANCEL</button>
        </div>
    </div>
</div>

<div id="liftModal" class="modal">
    <div class="modal-content">
        <h2 style="color: #0ff; margin-bottom: 12px; font-size: 1.6rem;">SELECT FLOOR</h2>
        <div id="floorButtons" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin: 12px 0;"></div>
        <button onclick="closeLift()" class="btn" style="width: 100%; font-size: 1rem;">CANCEL</button>
    </div>
</div>

<!-- AUDIO -->
<audio id="bgm" loop src="https://assets.codepen.io/605876/creepy-horror-ambience.mp3"></audio>
<audio id="gunSound" src="https://assets.codepen.io/605876/gunshot.mp3"></audio>
<audio id="hitSound" src="https://assets.codepen.io/605876/hit-marker.mp3"></audio>
<audio id="scareSound" src="https://assets.codepen.io/605876/jumpscare-scream.mp3"></audio>
<audio id="footstepSound" src="https://assets.codepen.io/605876/footstep-concrete.mp3"></audio>
<audio id="engineSound" src="https://assets.codepen.io/605876/car-engine-start.mp3"></audio>
<audio id="helicopterSound" src="https://assets.codepen.io/605876/helicopter-fly.mp3"></audio>

<script>
// ============================================
// FULLSCREEN MANAGEMENT - ALWAYS FULLSCREEN
// ============================================
function requestFullscreen() {
    const elem = document.documentElement;
    
    if (elem.requestFullscreen) {
        elem.requestFullscreen();
    } else if (elem.webkitRequestFullscreen) { /* Safari */
        elem.webkitRequestFullscreen();
    } else if (elem.msRequestFullscreen) { /* IE11 */
        elem.msRequestFullscreen();
    }
    
    // Hide browser UI on mobile
    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        setTimeout(() => {
            window.scrollTo(0, 1);
        }, 100);
    }
}

function exitFullscreen() {
    if (document.exitFullscreen) {
        document.exitFullscreen();
    } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
    } else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen();
    } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
    }
}

// Automatically go fullscreen on page load
window.addEventListener('load', () => {
    setTimeout(() => {
        requestFullscreen();
    }, 500);
});

// Also go fullscreen when orientation changes
window.addEventListener('orientationchange', () => {
    setTimeout(() => {
        requestFullscreen();
    }, 300);
});

// ============================================
// APP EXIT FUNCTION - CLOSE APP
// ============================================
function exitApp() {
    // Try different methods to close the app/browser
    if (navigator.app && navigator.app.exitApp) {
        // For Cordova/PhoneGap
        navigator.app.exitApp();
    } else if (navigator.device && navigator.device.exitApp) {
        // For other hybrid apps
        navigator.device.exitApp();
    } else {
        // For browsers - close window or tab
        if (window.history.length > 1) {
            window.history.back();
        } else {
            // Try to close the window/tab
            window.close();
            
            // If window.close doesn't work, redirect to about:blank
            setTimeout(() => {
                window.location.href = 'about:blank';
            }, 1000);
            
            // Show message
            alert("Tap back button again to exit");
        }
    }
}

// ============================================
// GAME VARIABLES
// ============================================
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let width = window.innerWidth;
let height = window.innerHeight;
canvas.width = width;
canvas.height = height;

let gameMode = 'easy';
let player = {
    x: width/2,
    y: height/2,
    hp: 100,
    keys: 0,
    bullets: 10,
    vx: 0,
    vy: 0,
    speed: 4.0,
    hidden: false,
    size: 18,
    hidingSpot: null,
    inventory: [],
    carParts: 0,
    hasGarageKey: false,
    hasHelicopterKey: false,
    hasOil: false,
    hasTape: false,
    hasRope: false,
    // Walking animation variables
    walkFrame: 0,
    walkTimer: 0,
    lastStepTime: 0,
    direction: 0, // 0: down, 1: left, 2: right, 3: up
    isMoving: false
};
let floor = 1, torchOn = false, battery = 100;
let ghosts = [], puzzles = [], stairsUp = null, stairsDown = null, elevator = null, exitDoor = null, hidingSpots = [];
let bullets = [], darkMode = false, carHealth = 0, inGarage = false, inHelicopterArea = false, monster = null;
let gameRunning = false;
let gameLoopId = null;
let lastTime = 0;
let mainDoor = {x: width/2, y: height-100, locked: true};
let rope = {x: width-100, y: height-150, collected: false};
let helicopter = {x: width/2, y: 100, active: false};

// Room structure: 10 floors, 2 puzzles per floor = 20 puzzles
const floors = 10;
let puzzlesSolved = 0;
const totalPuzzles = 20;

// Puzzle rewards - 20 unique items for 20 puzzles
const puzzleRewards = [
    // Floor 1 - Garage items
    { type: 'garagekey', name: 'Garage Key' },
    { type: 'toolbox', name: 'Toolbox' },
    
    // Floor 2 - Car parts
    { type: 'carpart', name: 'Engine Part' },
    { type: 'carpart', name: 'Transmission' },
    
    // Floor 3 - Helicopter items
    { type: 'helicopterkey', name: 'Helicopter Key' },
    { type: 'oil', name: 'Helicopter Oil' },
    
    // Floor 4 - More items
    { type: 'tape', name: 'Duct Tape' },
    { type: 'rope', name: 'Climbing Rope' },
    
    // Floor 5 - Weapons & Health
    { type: 'bullets', name: 'Ammo Pack', amount: 10 },
    { type: 'health', name: 'Med Kit', amount: 50 },
    
    // Floor 6 - More supplies
    { type: 'battery', name: 'Flashlight Battery', amount: 50 },
    { type: 'bullets', name: 'Ammo Pack', amount: 10 },
    
    // Floor 7
    { type: 'health', name: 'Med Kit', amount: 50 },
    { type: 'carpart', name: 'Wheel' },
    
    // Floor 8
    { type: 'battery', name: 'Flashlight Battery', amount: 50 },
    { type: 'carpart', name: 'Brake System' },
    
    // Floor 9
    { type: 'health', name: 'Med Kit', amount: 50 },
    { type: 'bullets', name: 'Ammo Pack', amount: 10 },
    
    // Floor 10 - Final items
    { type: 'maindoorkey', name: 'Main Door Key' },
    { type: 'health', name: 'Super Med Kit', amount: 100 }
];

// Garage items
let garageItems = [
    { type: 'toolbox', x: 0, y: 0, collected: false },
    { type: 'gasoline', x: 0, y: 0, collected: false },
    { type: 'carbattery', x: 0, y: 0, collected: false },
    { type: 'tire', x: 0, y: 0, collected: false }
];

// Joystick variables
let joystickActive = false;
let joystickX = 0;
let joystickY = 0;
let joystickStartX = 0;
let joystickStartY = 0;
const JOYSTICK_RADIUS = 35;

// Hide variables
let nearHidingSpot = false;

// ============================================
// SCREEN MANAGEMENT
// ============================================
function showScreen(screenId) {
    // Hide all screens
    ['startScreen','modeScreen','gameScreen','winScreen','gameoverScreen'].forEach(id => {
        document.getElementById(id).style.display = 'none';
    });
    
    // Show requested screen
    document.getElementById(screenId).style.display = 'flex';
    
    // Make sure we're in fullscreen
    requestFullscreen();
    
    // Handle game screen
    if (screenId === 'gameScreen') {
        // Show game elements
        canvas.style.display = 'block';
        document.getElementById('controls').style.display = 'block';
        document.getElementById('torch').style.display = 'block';
        document.getElementById('torch-beam').style.display = 'block';
        document.getElementById('darkness').style.display = 'block';
        document.getElementById('vignette').style.display = 'block';
        document.getElementById('blood').style.display = 'block';
        document.getElementById('hideText').style.display = 'block';
        document.getElementById('prompt').style.display = 'block';
        
        // Start game
        if (!gameRunning) {
            startGame();
        }
    } else {
        // Hide game elements
        canvas.style.display = 'none';
        document.getElementById('controls').style.display = 'none';
        document.getElementById('torch').style.display = 'none';
        document.getElementById('torch-beam').style.display = 'none';
        document.getElementById('darkness').style.display = 'none';
        document.getElementById('vignette').style.display = 'none';
        document.getElementById('blood').style.display = 'none';
        document.getElementById('hideText').style.display = 'none';
        document.getElementById('prompt').style.display = 'none';
        
        // Stop game
        if (gameRunning) {
            gameRunning = false;
            if (gameLoopId) cancelAnimationFrame(gameLoopId);
            document.getElementById('bgm').pause();
        }
    }
}

// ============================================
// GAME INITIALIZATION
// ============================================
document.getElementById('startBtn').onclick = () => showScreen('modeScreen');
document.getElementById('backBtn').onclick = () => showScreen('startScreen');

document.querySelectorAll('.mode-btn').forEach(btn => {
    btn.onclick = function() {
        gameMode = this.dataset.mode;
        showScreen('gameScreen');
    };
});

function startGame() {
    console.log("Starting game in", gameMode, "mode");
    
    // Stop any existing game
    if (gameLoopId) {
        cancelAnimationFrame(gameLoopId);
        gameLoopId = null;
    }
    
    // Reset game state
    gameRunning = true;
    player = {
        x: width/2,
        y: height/2,
        hp: 100,
        keys: 0,
        bullets: 10,
        vx: 0,
        vy: 0,
        speed: 4.0,
        hidden: false,
        size: 18,
        hidingSpot: null,
        inventory: [],
        carParts: 0,
        hasGarageKey: false,
        hasHelicopterKey: false,
        hasOil: false,
        hasTape: false,
        hasRope: false,
        hasMainDoorKey: false,
        walkFrame: 0,
        walkTimer: 0,
        lastStepTime: 0,
        direction: 0,
        isMoving: false
    };
    floor = 1;
    torchOn = false;
    battery = 100;
    ghosts = [];
    puzzles = [];
    stairsUp = null;
    stairsDown = null;
    elevator = null;
    exitDoor = null;
    hidingSpots = [];
    bullets = [];
    darkMode = (floor === 1);
    carHealth = 0;
    inGarage = false;
    inHelicopterArea = false;
    monster = null;
    puzzlesSolved = 0;
    mainDoor.locked = true;
    rope.collected = false;
    helicopter.active = false;
    
    // Reset garage items
    garageItems = [
        { type: 'toolbox', x: width * 0.3, y: height * 0.7, collected: false },
        { type: 'gasoline', x: width * 0.7, y: height * 0.7, collected: false },
        { type: 'carbattery', x: width * 0.3, y: height * 0.3, collected: false },
        { type: 'tire', x: width * 0.7, y: height * 0.3, collected: false }
    ];
    
    // Update UI
    updateUI();
    updateFloorIndicator();
    updateBatteryBar();
    document.getElementById('carHealthBar').style.display = 'none';
    
    // Set darkness for floor 1
    document.getElementById('darkness').style.opacity = darkMode ? 0.95 : 0;
    document.getElementById('torch').style.opacity = 0;
    document.getElementById('torch-beam').style.opacity = 0;
    
    // Start audio
    const bgm = document.getElementById('bgm');
    bgm.volume = 0.5;
    bgm.currentTime = 0;
    bgm.play().catch(e => console.log("Audio error:", e));
    
    // Initialize first floor
    initFloor(1);
    
    // Start game loop
    lastTime = Date.now();
    gameLoop();
}

// ============================================
// INVENTORY SYSTEM
// ============================================
function openInventory() {
    const container = document.getElementById('inventoryItems');
    container.innerHTML = '';
    
    if (player.inventory.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #a0a0a0; padding: 20px;">Inventory empty</p>';
    } else {
        player.inventory.forEach((item, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'inventory-item';
            
            let icon = '‚ùì';
            let description = '';
            
            switch(item.type) {
                case 'key': icon = 'üîë'; description = 'Apartment key'; break;
                case 'carpart': icon = 'üîß'; description = 'Car repair part'; break;
                case 'helicopterkey': icon = 'üöÅ'; description = 'Helicopter key'; break;
                case 'oil': icon = 'üõ¢Ô∏è'; description = 'Engine oil'; break;
                case 'tape': icon = 'üìº'; description = 'Duct tape'; break;
                case 'garagekey': icon = 'üöó'; description = 'Garage key'; break;
                case 'battery': icon = 'üîã'; description = 'Flashlight battery'; break;
                case 'bullets': icon = 'üî´'; description = 'Ammo pack'; break;
                case 'health': icon = '‚ù§Ô∏è'; description = 'Health kit'; break;
                case 'toolbox': icon = 'üß∞'; description = 'Toolbox'; break;
                case 'gasoline': icon = '‚õΩ'; description = 'Gasoline can'; break;
                case 'carbattery': icon = 'üîã'; description = 'Car battery'; break;
                case 'tire': icon = 'üõû'; description = 'Spare tire'; break;
                case 'rope': icon = 'ü™¢'; description = 'Climbing rope'; break;
                case 'maindoorkey': icon = 'üö™'; description = 'Main door key'; break;
            }
            
            itemDiv.innerHTML = `
                <div class="item-icon">${icon}</div>
                <div class="item-info">
                    <div class="item-name">${item.name || item.type.toUpperCase()}</div>
                    <div class="item-description">${description}</div>
                </div>
                <button class="use-btn" onclick="useItem(${index})">USE</button>
            `;
            
            container.appendChild(itemDiv);
        });
    }
    
    document.getElementById('inventoryPanel').style.display = 'block';
}

function closeInventory() {
    document.getElementById('inventoryPanel').style.display = 'none';
}

function addToInventory(item) {
    player.inventory.push(item);
}

function useItem(index) {
    if (index >= 0 && index < player.inventory.length) {
        const item = player.inventory[index];
        
        switch(item.type) {
            case 'battery':
                battery = Math.min(100, battery + 50);
                player.inventory.splice(index, 1);
                showAlert("üîã Battery used! +50% battery");
                updateBatteryBar();
                break;
                
            case 'bullets':
                player.bullets += 10;
                player.inventory.splice(index, 1);
                showAlert("üî´ Ammo used! +10 bullets");
                updateUI();
                break;
                
            case 'health':
                player.hp = Math.min(100, player.hp + (item.amount || 50));
                player.inventory.splice(index, 1);
                showAlert("‚ù§Ô∏è Health restored! +" + (item.amount || 50) + " HP");
                updateUI();
                break;
                
            case 'toolbox':
            case 'gasoline':
            case 'carbattery':
            case 'tire':
                if (inGarage && carHealth < 100) {
                    carHealth = Math.min(100, carHealth + 25);
                    player.inventory.splice(index, 1);
                    updateCarHealth();
                    showAlert(`üîß ${item.name || item.type.toUpperCase()} used! Car health: ${carHealth}%`);
                } else {
                    showAlert("Can only use this in garage on the car!");
                }
                break;
                
            case 'rope':
                if (floor === 10 && !player.hasRope) {
                    player.hasRope = true;
                    player.inventory.splice(index, 1);
                    showAlert("ü™¢ Rope equipped! Go to roof!");
                } else {
                    showAlert("Can only use rope on floor 10 to access roof!");
                }
                break;
                
            default:
                showAlert("Cannot use this item here");
        }
        
        openInventory(); // Refresh inventory
    }
}

// ============================================
// MOBILE CONTROLS
// ============================================
// Quit Button - EXIT APP
document.getElementById('quitBtn').addEventListener('touchstart', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    // Exit the app completely
    exitApp();
}, { passive: false });

// Joystick
const joystickArea = document.getElementById('joystickArea');
const joystick = document.getElementById('joystick');

joystickArea.addEventListener('touchstart', function(e) {
    e.preventDefault();
    e.stopPropagation();
    if (!gameRunning) return;
    
    joystickActive = true;
    const touch = e.touches[0];
    const rect = joystickArea.getBoundingClientRect();
    joystickStartX = rect.left + rect.width/2;
    joystickStartY = rect.top + rect.height/2;
    
    updateJoystick(touch.clientX, touch.clientY);
}, { passive: false });

joystickArea.addEventListener('touchmove', function(e) {
    e.preventDefault();
    e.stopPropagation();
    if (!joystickActive || !gameRunning) return;
    
    const touch = e.touches[0];
    updateJoystick(touch.clientX, touch.clientY);
}, { passive: false });

joystickArea.addEventListener('touchend', function(e) {
    e.preventDefault();
    e.stopPropagation();
    joystickActive = false;
    joystickX = 0;
    joystickY = 0;
    joystick.style.transform = 'translate(-50%, -50%)';
});

function updateJoystick(touchX, touchY) {
    let dx = touchX - joystickStartX;
    let dy = touchY - joystickStartY;
    const distance = Math.sqrt(dx*dx + dy*dy);
    
    if (distance > JOYSTICK_RADIUS) {
        dx = (dx/distance) * JOYSTICK_RADIUS;
        dy = (dy/distance) * JOYSTICK_RADIUS;
    }
    
    joystickX = dx;
    joystickY = dy;
    joystick.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
}

// SHOOT BUTTON - AIM WITH TOUCH POSITION
const shootBtn = document.getElementById('shootBtn');

shootBtn.addEventListener('touchstart', function(e) {
    e.preventDefault();
    e.stopPropagation();
    if (!gameRunning || player.bullets <= 0) return;
    
    const touch = e.touches[0];
    
    // Store the touch position for aiming
    const shootTouchX = touch.clientX;
    const shootTouchY = touch.clientY;
    
    // Calculate bullet direction
    const bulletDirectionX = shootTouchX - player.x;
    const bulletDirectionY = shootTouchY - player.y;
    const distance = Math.sqrt(bulletDirectionX * bulletDirectionX + bulletDirectionY * bulletDirectionY);
    
    // Normalize direction
    const dirX = bulletDirectionX / distance;
    const dirY = bulletDirectionY / distance;
    
    // Calculate target position
    const targetX = player.x + dirX * 500;
    const targetY = player.y + dirY * 500;
    
    // Shoot bullet
    shootBullet(targetX, targetY);
    
}, { passive: false });

// Shoot bullet function
function shootBullet(targetX, targetY) {
    player.bullets--;
    updateUI();
    
    // Play gun sound
    const gunSound = document.getElementById('gunSound');
    gunSound.currentTime = 0;
    gunSound.play().catch(e => console.log("Gun sound error"));
    
    // Create bullet
    bullets.push({
        x: player.x,
        y: player.y,
        tx: targetX,
        ty: targetY,
        life: 40
    });
    
    // Check hit with ghosts
    ghosts = ghosts.filter(g => {
        const bulletStartX = player.x;
        const bulletStartY = player.y;
        const bulletEndX = player.x + (targetX - player.x) * 0.3;
        const bulletEndY = player.y + (targetY - player.y) * 0.3;
        
        const distanceToLine = pointToLineDistance(g.x, g.y, bulletStartX, bulletStartY, bulletEndX, bulletEndY);
        
        if (distanceToLine < 50) {
            // Hit sound
            document.getElementById('hitSound').currentTime = 0;
            document.getElementById('hitSound').play().catch(e => console.log("Hit sound error"));
            
            // Blood effect
            document.getElementById('blood').style.setProperty('--blood-x', g.x + 'px');
            document.getElementById('blood').style.setProperty('--blood-y', g.y + 'px');
            document.getElementById('blood').style.opacity = 1;
            setTimeout(() => {
                document.getElementById('blood').style.opacity = 0;
            }, 500);
            
            // Blood particles
            for (let i = 0; i < 6; i++) {
                bullets.push({
                    x: g.x,
                    y: g.y,
                    tx: g.x + (Math.random()-0.5)*150,
                    ty: g.y + (Math.random()-0.5)*150,
                    life: 20,
                    blood: true
                });
            }
            
            return false; // Remove ghost
        }
        return true;
    });
    
    // Check hit with monster
    if (monster && Math.hypot(monster.x - player.x, monster.y - player.y) < 200) {
        const bulletStartX = player.x;
        const bulletStartY = player.y;
        const bulletEndX = player.x + (targetX - player.x) * 0.3;
        const bulletEndY = player.y + (targetY - player.y) * 0.3;
        
        const distanceToLine = pointToLineDistance(monster.x, monster.y, bulletStartX, bulletStartY, bulletEndX, bulletEndY);
        
        if (distanceToLine < 80) {
            monster.hp -= 20;
            showAlert(`üíÄ Monster HP: ${monster.hp}/1000`);
            
            if (monster.hp <= 0) {
                monster = null;
                showAlert("üéâ Monster defeated! Now use helicopter!");
                helicopter.active = true;
            }
        }
    }
}

// Calculate distance from point to line
function pointToLineDistance(px, py, x1, y1, x2, y2) {
    const A = px - x1;
    const B = py - y1;
    const C = x2 - x1;
    const D = y2 - y1;

    const dot = A * C + B * D;
    const lenSq = C * C + D * D;
    let param = -1;
    
    if (lenSq !== 0) {
        param = dot / lenSq;
    }

    let xx, yy;

    if (param < 0) {
        xx = x1;
        yy = y1;
    } else if (param > 1) {
        xx = x2;
        yy = y2;
    } else {
        xx = x1 + param * C;
        yy = y1 + param * D;
    }

    const dx = px - xx;
    const dy = py - yy;
    
    return Math.sqrt(dx * dx + dy * dy);
}

// ACTION BUTTON - HIDE/INTERACT
const actionBtn = document.getElementById('actionBtn');

actionBtn.addEventListener('touchstart', function(e) {
    e.preventDefault();
    e.stopPropagation();
    if (!gameRunning) return;
    
    if (player.hidden) {
        // If already hiding, come out of hiding
        player.hidden = false;
        player.hidingSpot = null;
        document.getElementById('hideText').style.opacity = 0;
        
        // Reset ghost movement
        ghosts.forEach(g => {
            g.wandering = false;
        });
    } else if (nearHidingSpot) {
        // If near hiding spot, hide
        player.hidden = true;
        document.getElementById('hideText').style.opacity = 1;
        
        // Find the nearest hiding spot
        let closestSpot = null;
        let closestDistance = Infinity;
        
        hidingSpots.forEach(spot => {
            const dist = Math.hypot(spot.x - player.x, spot.y - player.y);
            if (dist < 60 && dist < closestDistance) {
                closestDistance = dist;
                closestSpot = spot;
            }
        });
        
        if (closestSpot) {
            player.hidingSpot = closestSpot;
            player.x = closestSpot.x;
            player.y = closestSpot.y;
        }
        
        // Make ghosts wander randomly
        ghosts.forEach(g => {
            g.wandering = true;
            g.wanderTargetX = g.x + (Math.random()-0.5)*200;
            g.wanderTargetY = g.y + (Math.random()-0.5)*200;
        });
        
        setTimeout(() => {
            document.getElementById('hideText').style.opacity = 0;
        }, 1500);
    } else {
        // Check for interactions
        
        // Check puzzles
        for (let p of puzzles) {
            if (!p.solved && Math.hypot(p.x - player.x, p.y - player.y) < 70) {
                openPuzzle(p);
                return;
            }
        }
        
        // Check elevator
        if (elevator && Math.hypot(elevator.x - player.x, elevator.y - player.y) < 90) {
            openLift();
            return;
        }
        
        // Check stairs
        if (stairsDown && Math.hypot(stairsDown.x - player.x, stairsDown.y - player.y) < 60) {
            changeFloor(stairsDown.to);
            return;
        }
        
        if (stairsUp && Math.hypot(stairsUp.x - player.x, stairsUp.y - player.y) < 60) {
            changeFloor(stairsUp.to);
            return;
        }
        
        // Check main door (floor 1)
        if (floor === 1 && Math.hypot(mainDoor.x - player.x, mainDoor.y - player.y) < 100) {
            if (player.hasMainDoorKey) {
                mainDoorEscape();
            } else {
                showAlert("üö™ Need main door key!");
            }
            return;
        }
        
        // Check rope (floor 10)
        if (floor === 10 && !rope.collected && Math.hypot(rope.x - player.x, rope.y - player.y) < 60) {
            rope.collected = true;
            addToInventory({type: 'rope', name: 'Climbing Rope'});
            showAlert("ü™¢ Found climbing rope! Use it from inventory on floor 10!");
            return;
        }
        
        // Check roof access (floor 10 with rope)
        if (floor === 10 && player.hasRope && Math.hypot(width/2 - player.x, 100 - player.y) < 80) {
            // Go to roof (floor 11)
            changeFloor(11);
            return;
        }
        
        // Check helicopter (roof/floor 11)
        if (floor === 11 && helicopter.active && Math.hypot(helicopter.x - player.x, helicopter.y - player.y) < 100) {
            if (player.hasHelicopterKey && player.hasOil && player.hasTape) {
                helicopterEscape();
            } else {
                showAlert("Need helicopter key, oil, and duct tape!");
            }
            return;
        }
        
        // Check garage (floor 1 special area)
        if (floor === 1 && Math.hypot(width-100 - player.x, height/2 - player.y) < 90) {
            // Enter garage
            inGarage = true;
            document.getElementById('carHealthBar').style.display = 'block';
            carHealth = 30;
            updateCarHealth();
            showAlert("üöó Entered garage! Repair the car to escape!");
            return;
        }
        
        // Check car repair (in garage)
        if (inGarage && carHealth < 100 && Math.hypot(width/2 - player.x, height/2 - player.y) < 120) {
            // Check if player has repair items in inventory
            let hasRepairItem = false;
            for (let i = player.inventory.length - 1; i >= 0; i--) {
                const item = player.inventory[i];
                if (item.type === 'toolbox' || item.type === 'gasoline' || 
                    item.type === 'carbattery' || item.type === 'tire') {
                    carHealth = Math.min(100, carHealth + 25);
                    player.inventory.splice(i, 1);
                    updateCarHealth();
                    showAlert(`üîß ${item.name} used! Car health: ${carHealth}%`);
                    hasRepairItem = true;
                    break;
                }
            }
            
            if (!hasRepairItem) {
                showAlert("Need repair items (toolbox, gasoline, battery, tire)!");
            }
            return;
        }
        
        // Check car escape (in garage)
        if (inGarage && carHealth >= 100 && player.hasGarageKey && 
            Math.hypot(width/2 - player.x, height/2 - player.y) < 120) {
            carEscape();
            return;
        }
        
        // Check garage items
        if (inGarage) {
            for (let item of garageItems) {
                if (!item.collected && Math.hypot(item.x - player.x, item.y - player.y) < 50) {
                    item.collected = true;
                    addToInventory({type: item.type, name: item.type.charAt(0).toUpperCase() + item.type.slice(1)});
                    showAlert(`üéâ Found ${item.type.toUpperCase()}!`);
                    return;
                }
            }
        }
        
        // Exit garage
        if (inGarage && Math.hypot(100 - player.x, height/2 - player.y) < 80) {
            inGarage = false;
            document.getElementById('carHealthBar').style.display = 'none';
            showAlert("Left garage");
            return;
        }
    }
}, { passive: false });

// Flashlight Button
document.getElementById('flashlightBtn').addEventListener('touchstart', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    if (darkMode) { // Only works on floor 1 (dark mode)
        if (battery > 0) {
            torchOn = !torchOn;
            const btn = document.getElementById('flashlightBtn');
            btn.style.background = torchOn ? 'rgba(100,100,0,0.9)' : 'rgba(40,40,0,0.6)';
            btn.style.borderColor = torchOn ? '#ff0' : '#cc0';
            
            // Update torch opacity
            document.getElementById('torch').style.opacity = torchOn ? 1 : 0;
            document.getElementById('torch-beam').style.opacity = torchOn ? 0.7 : 0;
        } else {
            showAlert("üîã No battery!");
            torchOn = false;
            document.getElementById('torch').style.opacity = 0;
            document.getElementById('torch-beam').style.opacity = 0;
        }
    } else {
        showAlert("üî¶ Flashlight only works on Floor 1!");
    }
}, { passive: false });

// Inventory Button
document.getElementById('inventoryBtn').addEventListener('touchstart', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    openInventory();
}, { passive: false });

// ============================================
// PLAYER WALKING ANIMATION FUNCTIONS
// ============================================
function updatePlayerAnimation(deltaTime) {
    // Determine if player is moving
    const isActuallyMoving = (player.vx !== 0 || player.vy !== 0) && !player.hidden;
    player.isMoving = isActuallyMoving;
    
    // Update direction based on movement
    if (isActuallyMoving) {
        // Determine primary direction
        const absVx = Math.abs(player.vx);
        const absVy = Math.abs(player.vy);
        
        if (absVx > absVy) {
            player.direction = player.vx > 0 ? 2 : 1; // right : left
        } else {
            player.direction = player.vy > 0 ? 0 : 3; // down : up
        }
        
        // Update walk animation
        player.walkTimer += deltaTime;
        if (player.walkTimer > 150) { // Every 150ms change frame
            player.walkTimer = 0;
            player.walkFrame = (player.walkFrame + 1) % 4; // 4 frames for walking
            
            // Play footstep sound occasionally
            if (player.walkFrame % 2 === 0 && Date.now() - player.lastStepTime > 300) {
                player.lastStepTime = Date.now();
                const footstep = document.getElementById('footstepSound');
                footstep.currentTime = 0;
                footstep.volume = 0.3;
                footstep.play().catch(e => console.log("Footstep sound error"));
            }
        }
    } else {
        // Reset to standing position when not moving
        player.walkFrame = 0;
        player.walkTimer = 0;
    }
}

function drawPlayer() {
    const size = player.size;
    const frame = player.walkFrame;
    const dir = player.direction;
    
    // Save context state
    ctx.save();
    
    // Translate to player position
    ctx.translate(player.x, player.y);
    
    // Draw player based on direction and animation frame
    if (player.hidden) {
        // Hidden player - just a dark shadow
        ctx.fillStyle = '#222';
        ctx.fillRect(-size/2, -size, size, size*2);
    } else {
        // Draw player body (color changes based on health)
        const healthColor = player.hp > 50 ? '#fff' : player.hp > 25 ? '#fcc' : '#f66';
        ctx.fillStyle = healthColor;
        
        // Body with walking animation
        const bodyWidth = size;
        const bodyHeight = size * 1.8;
        
        // Main body
        ctx.fillRect(-bodyWidth/2, -bodyHeight/2, bodyWidth, bodyHeight);
        
        // Head
        ctx.fillStyle = '#ffd';
        ctx.fillRect(-size/3, -bodyHeight/2 - 5, size*0.66, size*0.8);
        
        // Face (simple eyes)
        ctx.fillStyle = '#000';
        ctx.fillRect(-size/4, -bodyHeight/2, 3, 3);
        ctx.fillRect(size/4 - 3, -bodyHeight/2, 3, 3);
        
        // Arms with walking animation
        ctx.fillStyle = healthColor;
        
        if (dir === 0 || dir === 3) { // Down or Up
            // Regular arm position with slight animation
            const armSwing = frame === 1 ? 5 : frame === 3 ? -5 : 0;
            ctx.fillRect(-size*0.8, -size/4 + armSwing, size*0.6, size*0.8);
            ctx.fillRect(size*0.2, -size/4 - armSwing, size*0.6, size*0.8);
        } else if (dir === 1) { // Left
            // Arms in walking motion
            const frontArm = frame === 1 ? -5 : frame === 3 ? 5 : 0;
            const backArm = frame === 1 ? 5 : frame === 3 ? -5 : 0;
            ctx.fillRect(-size*0.8, -size/4 + frontArm, size*0.6, size*0.8);
            ctx.fillRect(size*0.2, -size/4 + backArm, size*0.6, size*0.8);
        } else if (dir === 2) { // Right
            // Arms in walking motion (mirrored)
            const frontArm = frame === 1 ? 5 : frame === 3 ? -5 : 0;
            const backArm = frame === 1 ? -5 : frame === 3 ? 5 : 0;
            ctx.fillRect(-size*0.8, -size/4 + backArm, size*0.6, size*0.8);
            ctx.fillRect(size*0.2, -size/4 + frontArm, size*0.6, size*0.8);
        }
        
        // Legs with walking animation
        ctx.fillStyle = '#333';
        const legWidth = size*0.4;
        const legHeight = size*0.8;
        
        if (dir === 0 || dir === 3) { // Down or Up
            // Standing legs with slight animation
            const legSpread = frame === 1 ? 2 : frame === 3 ? -2 : 0;
            ctx.fillRect(-size/3 + legSpread, size*0.6, legWidth, legHeight);
            ctx.fillRect(size/3 - legWidth - legSpread, size*0.6, legWidth, legHeight);
        } else if (dir === 1) { // Left
            // Walking legs
            const frontLeg = frame === 1 ? -3 : frame === 3 ? 3 : 0;
            const backLeg = frame === 1 ? 3 : frame === 3 ? -3 : 0;
            ctx.fillRect(-size/3 + frontLeg, size*0.6, legWidth, legHeight);
            ctx.fillRect(size/3 - legWidth + backLeg, size*0.6, legWidth, legHeight);
        } else if (dir === 2) { // Right
            // Walking legs (mirrored)
            const frontLeg = frame === 1 ? 3 : frame === 3 ? -3 : 0;
            const backLeg = frame === 1 ? -3 : frame === 3 ? 3 : 0;
            ctx.fillRect(-size/3 + backLeg, size*0.6, legWidth, legHeight);
            ctx.fillRect(size/3 - legWidth + frontLeg, size*0.6, legWidth, legHeight);
        }
        
        // Draw small indicator for flashlight when on
        if (torchOn && battery > 0) {
            ctx.fillStyle = '#ff0';
            ctx.beginPath();
            ctx.arc(0, -size*0.8, 3, 0, Math.PI * 2);
            ctx.fill();
        }
    }
    
    // Restore context
    ctx.restore();
}

// ============================================
// GAME LOGIC
// ============================================
function initFloor(f) {
    floor = f;
    ghosts = [];
    puzzles = [];
    stairsUp = null;
    stairsDown = null;
    elevator = null;
    exitDoor = null;
    hidingSpots = [];
    bullets = [];
    darkMode = (f === 1);
    
    if (f === 11) {
        // Roof level - helicopter escape
        inHelicopterArea = true;
        monster = {
            x: width/2,
            y: height/3,
            hp: 1000,
            size: 80,
            speed: 1.0,
            floatOffset: Math.random() * Math.PI * 2
        };
        helicopter.active = false;
    } else {
        inHelicopterArea = false;
        monster = null;
        helicopter.active = false;
    }
    
    // Update darkness and torch
    document.getElementById('darkness').style.opacity = darkMode ? 0.95 : 0;
    
    // Only show flashlight button on floor 1
    const flashlightBtn = document.getElementById('flashlightBtn');
    if (darkMode) {
        flashlightBtn.style.display = 'flex';
        // Reset flashlight state
        torchOn = false;
        document.getElementById('torch').style.opacity = 0;
        document.getElementById('torch-beam').style.opacity = 0;
        flashlightBtn.style.background = 'rgba(40,40,0,0.6)';
        flashlightBtn.style.borderColor = '#cc0';
    } else {
        flashlightBtn.style.display = 'none';
        torchOn = false;
        document.getElementById('torch').style.opacity = 0;
        document.getElementById('torch-beam').style.opacity = 0;
    }
    
    // Create 2 puzzles per floor (total 20)
    const puzzleIndex = (f-1) * 2;
    if (puzzleIndex < puzzleRewards.length) {
        // First puzzle of the floor
        puzzles.push({
            x: width * 0.3,
            y: height * 0.4,
            solved: false,
            reward: puzzleRewards[puzzleIndex]
        });
        
        // Second puzzle of the floor
        if (puzzleIndex + 1 < puzzleRewards.length) {
            puzzles.push({
                x: width * 0.7,
                y: height * 0.4,
                solved: false,
                reward: puzzleRewards[puzzleIndex + 1]
            });
        }
    }
    
    // Ghost settings based on difficulty
    let ghostCount = 4;
    let ghostSpeed = 1.4;
    let ghostDamage = 0.3;
    
    switch(gameMode) {
        case 'easy': 
            ghostCount = 3; 
            ghostSpeed = 1.0; 
            ghostDamage = 0.2; 
            break;
        case 'normal': 
            ghostCount = 4; 
            ghostSpeed = 1.4; 
            ghostDamage = 0.3; 
            break;
        case 'hard': 
            ghostCount = 5; 
            ghostSpeed = 1.8; 
            ghostDamage = 0.5; 
            break;
        case 'impossible': 
            ghostCount = 6; 
            ghostSpeed = 2.2; 
            ghostDamage = 0.8; 
            break;
    }
    
    // Create ghosts (not on roof)
    if (f !== 11) {
        for (let i = 0; i < ghostCount; i++) {
            ghosts.push({
                x: 100 + Math.random()*(width-200),
                y: 100 + Math.random()*(height-200),
                speed: ghostSpeed + Math.random()*0.5,
                damage: ghostDamage,
                size: 30,
                wandering: false,
                wanderTargetX: 0,
                wanderTargetY: 0,
                floatOffset: Math.random() * Math.PI * 2
            });
        }
    }
    
    // Elevator and stairs
    elevator = {x: width/2, y: height-100};
    if (f > 1) stairsDown = {x: 70, y: height/2, to: f-1};
    if (f < 10) stairsUp = {x: width-70, y: height/2, to: f+1};
    
    // Hiding spots (not on roof or in special areas)
    if (f !== 11 && !inGarage) {
        hidingSpots = [
            {x: 70, y: 90},
            {x: 70, y: height-90},
            {x: width-70, y: 90},
            {x: width-70, y: height-90}
        ];
    }
    
    updateFloorIndicator();
    updateUI();
}

function updateUI() {
    document.getElementById('healthFill').style.width = player.hp + '%';
    document.getElementById('healthText').textContent = 
        `HP: ${Math.floor(player.hp)} | BULLETS: ${player.bullets} | PUZZLES: ${puzzlesSolved}/20`;
}

function updateBatteryBar() {
    document.getElementById('batteryFill').style.width = battery + '%';
}

function updateCarHealth() {
    document.getElementById('carHealthFill').style.width = carHealth + '%';
    document.getElementById('carHealthText').textContent = `CAR HP: ${carHealth}%`;
}

function updateFloorIndicator() {
    if (floor === 11) {
        document.getElementById('floorIndicator').textContent = `ROOF`;
    } else if (inGarage) {
        document.getElementById('floorIndicator').textContent = `GARAGE`;
    } else {
        document.getElementById('floorIndicator').textContent = `FLOOR: ${floor}`;
    }
}

// ============================================
// GAME LOOP
// ============================================
function gameLoop() {
    if (!gameRunning) return;
    
    try {
        const currentTime = Date.now();
        const deltaTime = currentTime - lastTime;
        lastTime = currentTime;
        
        // Clear canvas
        if (inGarage) {
            // Garage background
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, 0, width, height);
            
            // Draw garage details
            ctx.fillStyle = '#333';
            // Floor
            for (let i = 0; i < 10; i++) {
                ctx.fillRect(0, height - 50 - i*2, width, 1);
            }
            
            // Walls
            ctx.fillStyle = '#222';
            ctx.fillRect(0, 0, width, 50);
            ctx.fillRect(0, 0, 50, height);
            ctx.fillRect(width-50, 0, 50, height);
            
            // Shelves
            ctx.fillStyle = '#555';
            for (let i = 0; i < 4; i++) {
                ctx.fillRect(60, 80 + i*70, 40, 50);
                ctx.fillRect(width - 100, 80 + i*70, 40, 50);
            }
            
        } else if (floor === 11) {
            // Roof background
            ctx.fillStyle = '#0a1a2a';
            ctx.fillRect(0, 0, width, height);
            
            // Stars
            ctx.fillStyle = '#fff';
            for (let i = 0; i < 50; i++) {
                const x = (i * 37) % width;
                const y = (i * 23) % height;
                ctx.fillRect(x, y, 1, 1);
            }
            
            // Roof edge
            ctx.fillStyle = '#333';
            ctx.fillRect(0, 0, width, 30);
            ctx.fillRect(0, height-30, width, 30);
            ctx.fillRect(0, 0, 30, height);
            ctx.fillRect(width-30, 0, 30, height);
            
        } else {
            // Regular floor background
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, width, height);
            
            // Draw walls
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, 0, width, 50);
            ctx.fillRect(0, height-50, width, 50);
            ctx.fillRect(0, 0, 50, height);
            ctx.fillRect(width-50, 0, 50, height);
        }
        
        // Player movement (only if not hidden)
        if (!player.hidden) {
            if (joystickActive) {
                const moveX = joystickX / JOYSTICK_RADIUS;
                const moveY = joystickY / JOYSTICK_RADIUS;
                player.vx = moveX * player.speed;
                player.vy = moveY * player.speed;
            } else {
                player.vx *= 0.8;
                player.vy *= 0.8;
            }
            
            player.x += player.vx;
            player.y += player.vy;
            
            // Keep player in bounds
            player.x = Math.max(60, Math.min(width-60, player.x));
            player.y = Math.max(60, Math.min(height-60, player.y));
        }
        
        // Update player animation
        updatePlayerAnimation(deltaTime);
        
        // Draw bullets
        for (let i = bullets.length-1; i >= 0; i--) {
            const b = bullets[i];
            const dx = b.tx - b.x;
            const dy = b.ty - b.y;
            const dist = Math.hypot(dx, dy);
            
            if (dist < 15 || b.life-- <= 0) {
                bullets.splice(i, 1);
                continue;
            }
            
            b.x += dx/dist * 22;
            b.y += dy/dist * 22;
            
            ctx.strokeStyle = b.blood ? '#f00' : '#ff0';
            ctx.lineWidth = b.blood ? 3 : 4;
            ctx.beginPath();
            ctx.moveTo(b.x, b.y);
            ctx.lineTo(b.x + dx*0.3, b.y + dy*0.3);
            ctx.stroke();
            
            // Glow effect for normal bullets
            if (!b.blood) {
                ctx.shadowColor = '#ff0';
                ctx.shadowBlur = 8;
                ctx.stroke();
                ctx.shadowBlur = 0;
            }
        }
        
        // Torch effect
        const torch = document.getElementById('torch');
        const torchBeam = document.getElementById('torch-beam');
        
        if (darkMode) {
            // Update torch position
            torch.style.setProperty('--x', player.x + 'px');
            torch.style.setProperty('--y', player.y + 'px');
            torchBeam.style.setProperty('--x', player.x + 'px');
            torchBeam.style.setProperty('--y', player.y + 'px');
            
            // Update beam angle based on movement direction
            let angle = 0;
            if (player.direction === 1) angle = 180; // left
            else if (player.direction === 2) angle = 0; // right
            else if (player.direction === 3) angle = 270; // up
            else angle = 90; // down
            
            torchBeam.style.setProperty('--angle', angle + 'deg');
            
            // Update torch opacity and battery
            if (torchOn && battery > 0) {
                torch.style.opacity = 1;
                torchBeam.style.opacity = 0.7;
                battery -= 0.02;
                if (battery <= 0) {
                    battery = 0;
                    torchOn = false;
                    torch.style.opacity = 0;
                    torchBeam.style.opacity = 0;
                    const btn = document.getElementById('flashlightBtn');
                    btn.style.background = 'rgba(40,40,0,0.6)';
                    btn.style.borderColor = '#cc0';
                    showAlert("üîã Flashlight battery empty!");
                }
                updateBatteryBar();
            } else {
                torch.style.opacity = 0;
                torchBeam.style.opacity = 0;
            }
        } else {
            torch.style.opacity = 0;
            torchBeam.style.opacity = 0;
        }
        
        // Draw player using new animation function
        drawPlayer();
        
        // Check if player is near a hiding spot (not in special areas)
        if (!inGarage && floor !== 11) {
            nearHidingSpot = false;
            hidingSpots.forEach(spot => {
                const dist = Math.hypot(spot.x - player.x, spot.y - player.y);
                if (dist < 60 && !player.hidden) {
                    nearHidingSpot = true;
                }
            });
        } else {
            nearHidingSpot = false;
        }
        
        // Update and draw ghosts (not in special areas)
        if (!inGarage && floor !== 11) {
            const time = currentTime * 0.001;
            for (const g of ghosts) {
                // Ghost floating animation
                g.floatOffset += 0.02;
                const floatY = Math.sin(g.floatOffset) * 3;
                
                if (player.hidden) {
                    // If player is hidden, ghosts wander randomly
                    if (g.wandering) {
                        const dx = g.wanderTargetX - g.x;
                        const dy = g.wanderTargetY - g.y;
                        const dist = Math.hypot(dx, dy);
                        
                        if (dist < 30) {
                            // Set new random wander target
                            g.wanderTargetX = g.x + (Math.random()-0.5)*300;
                            g.wanderTargetY = g.y + (Math.random()-0.5)*300;
                        } else {
                            g.x += dx/dist * (g.speed * 0.5);
                            g.y += dy/dist * (g.speed * 0.5);
                        }
                    }
                } else {
                    // If player is not hidden, ghosts chase player
                    const dx = player.x - g.x;
                    const dy = player.y - g.y;
                    const dist = Math.hypot(dx, dy);
                    
                    if (dist > 25) {
                        g.x += dx/dist * g.speed;
                        g.y += dy/dist * g.speed;
                    }
                }
                
                // Draw ghost body with floating effect
                ctx.save();
                ctx.translate(g.x, g.y + floatY);
                
                // Ghost body with pulsing glow
                const pulse = Math.sin(time * 2 + g.floatOffset) * 0.2 + 0.8;
                ctx.fillStyle = '#111';
                ctx.beginPath();
                ctx.arc(0, 0, g.size * pulse, 0, Math.PI*2);
                ctx.fill();
                
                // Glow effect
                ctx.shadowColor = '#f00';
                ctx.shadowBlur = 20 * pulse;
                ctx.fill();
                ctx.shadowBlur = 0;
                
                // Eyes
                ctx.fillStyle = '#300';
                ctx.beginPath();
                ctx.arc(-10, -8, 6 * pulse, 0, Math.PI*2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(10, -8, 6 * pulse, 0, Math.PI*2);
                ctx.fill();
                
                // Pupils with pulsing effect
                const pupilPulse = Math.sin(time * 3 + g.floatOffset) * 0.3 + 0.7;
                ctx.fillStyle = '#f00';
                ctx.beginPath();
                ctx.arc(-10, -8, 3 * pupilPulse, 0, Math.PI*2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(10, -8, 3 * pupilPulse, 0, Math.PI*2);
                ctx.fill();
                
                ctx.restore();
                
                // Damage player (only if not hidden)
                if (Math.hypot(g.x - player.x, g.y + floatY - player.y) < player.size + g.size && !player.hidden) {
                    player.hp -= g.damage;
                    document.getElementById('blood').style.setProperty('--blood-x', g.x + 'px');
                    document.getElementById('blood').style.setProperty('--blood-y', g.y + 'px');
                    document.getElementById('blood').style.opacity = 1;
                    setTimeout(() => {
                        document.getElementById('blood').style.opacity = 0;
                    }, 300);
                    
                    if (player.hp <= 0) {
                        player.hp = 0;
                        gameOver();
                    }
                    
                    updateUI();
                }
            }
        }
        
        // Draw hiding spots (not in special areas)
        if (!inGarage && floor !== 11) {
            hidingSpots.forEach(s => {
                const isCurrentHidingSpot = player.hidingSpot && s.x === player.hidingSpot.x && s.y === player.hidingSpot.y;
                ctx.fillStyle = isCurrentHidingSpot ? '#003300' : '#222';
                ctx.fillRect(s.x - 40, s.y - 50, 80, 100);
                
                // Cabinet doors
                ctx.fillStyle = isCurrentHidingSpot ? '#112211' : '#433';
                ctx.fillRect(s.x - 32, s.y - 40, 28, 80);
                ctx.fillRect(s.x + 4, s.y - 40, 28, 80);
                
                // Label
                ctx.fillStyle = '#0f0';
                ctx.font = '12px "Courier New"';
                ctx.textAlign = 'center';
                ctx.fillText("HIDE", s.x, s.y);
            });
        }
        
        // Draw puzzles
        puzzles.forEach(p => {
            if (!p.solved) {
                const color = '#ff0';
                ctx.fillStyle = color;
                ctx.fillRect(p.x - 40, p.y - 40, 80, 80);
                ctx.fillStyle = '#000';
                ctx.fillRect(p.x - 28, p.y - 28, 56, 56);
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 16px "Courier New"';
                ctx.textAlign = 'center';
                
                let rewardText = "?";
                if (p.reward.type === 'key') rewardText = "KEY";
                else if (p.reward.type === 'carpart') rewardText = "PART";
                else if (p.reward.type === 'helicopterkey') rewardText = "H-KEY";
                else if (p.reward.type === 'oil') rewardText = "OIL";
                else if (p.reward.type === 'tape') rewardText = "TAPE";
                else if (p.reward.type === 'garagekey') rewardText = "G-KEY";
                else if (p.reward.type === 'battery') rewardText = "BATT";
                else if (p.reward.type === 'bullets') rewardText = "AMMO";
                else if (p.reward.type === 'health') rewardText = "HEAL";
                else if (p.reward.type === 'toolbox') rewardText = "TOOL";
                else if (p.reward.type === 'rope') rewardText = "ROPE";
                else if (p.reward.type === 'maindoorkey') rewardText = "M-KEY";
                
                ctx.fillText(rewardText, p.x, p.y + 5);
                
                // Glow effect
                ctx.shadowColor = color;
                ctx.shadowBlur = 15;
                ctx.fillRect(p.x - 40, p.y - 40, 80, 80);
                ctx.shadowBlur = 0;
            }
        });
        
        // Draw elevator (not in garage or roof)
        if (elevator && !inGarage && floor !== 11) {
            ctx.fillStyle = '#333';
            ctx.fillRect(elevator.x - 50, elevator.y - 50, 100, 100);
            ctx.fillStyle = '#0ff';
            ctx.font = 'bold 18px "Courier New"';
            ctx.textAlign = 'center';
            ctx.fillText("LIFT", elevator.x, elevator.y - 12);
        }
        
        // Draw stairs (not in garage or roof)
        if (stairsDown && !inGarage && floor !== 11) {
            ctx.fillStyle = '#444';
            ctx.fillRect(stairsDown.x - 35, stairsDown.y - 40, 70, 80);
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 22px "Courier New"';
            ctx.textAlign = 'center';
            ctx.fillText("DN", stairsDown.x, stairsDown.y + 6);
        }
        
        if (stairsUp && !inGarage && floor !== 11) {
            ctx.fillStyle = '#444';
            ctx.fillRect(stairsUp.x - 35, stairsUp.y - 40, 70, 80);
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 22px "Courier New"';
            ctx.textAlign = 'center';
            ctx.fillText("UP", stairsUp.x, stairsUp.y + 6);
        }
        
        // Draw main door (floor 1)
        if (floor === 1 && !inGarage) {
            ctx.fillStyle = mainDoor.locked ? '#800' : '#080';
            ctx.fillRect(mainDoor.x - 80, mainDoor.y - 60, 160, 120);
            ctx.fillStyle = '#000';
            ctx.fillRect(mainDoor.x - 60, mainDoor.y - 40, 120, 80);
            
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 24px "Courier New"';
            ctx.textAlign = 'center';
            if (mainDoor.locked) {
                ctx.fillText("MAIN DOOR", mainDoor.x, mainDoor.y + 10);
                ctx.font = '16px "Courier New"';
                ctx.fillText("LOCKED", mainDoor.x, mainDoor.y + 35);
            } else {
                ctx.fillText("EXIT", mainDoor.x, mainDoor.y + 10);
            }
        }
        
        // Draw rope (floor 10)
        if (floor === 10 && !rope.collected) {
            ctx.fillStyle = '#8B4513';
            // Draw rope coil
            ctx.beginPath();
            ctx.arc(rope.x, rope.y, 30, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 32px Arial';
            ctx.textAlign = 'center';
            ctx.fillText("ü™¢", rope.x, rope.y + 10);
            
            // Label
            ctx.font = '14px "Courier New"';
            ctx.fillText("ROPE", rope.x, rope.y + 40);
        }
        
        // Draw garage entrance (floor 1)
        if (floor === 1 && !inGarage) {
            ctx.fillStyle = '#444';
            ctx.fillRect(width - 120, height/2 - 50, 80, 100);
            ctx.fillStyle = '#666';
            // Garage door lines
            for (let i = 0; i < 4; i++) {
                ctx.fillRect(width - 115 + i*18, height/2 - 40, 2, 80);
            }
            
            ctx.fillStyle = '#ff0';
            ctx.font = 'bold 18px "Courier New"';
            ctx.textAlign = 'center';
            ctx.fillText("GARAGE", width - 80, height/2 - 60);
        }
        
        // Draw garage contents
        if (inGarage) {
            // Draw car
            const carX = width/2;
            const carY = height/2;
            
            // Car body
            ctx.fillStyle = '#800';
            ctx.fillRect(carX - 100, carY - 60, 200, 120);
            
            // Car windows
            ctx.fillStyle = '#0af';
            ctx.fillRect(carX - 80, carY - 40, 70, 50);
            ctx.fillRect(carX + 10, carY - 40, 70, 50);
            
            // Car details
            ctx.fillStyle = '#000';
            // Headlights
            ctx.fillRect(carX - 95, carY - 30, 15, 20);
            ctx.fillRect(carX + 80, carY - 30, 15, 20);
            // Wheels
            ctx.fillStyle = '#222';
            ctx.fillRect(carX - 85, carY + 40, 40, 20);
            ctx.fillRect(carX + 45, carY + 40, 40, 20);
            
            // Car status
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 20px "Courier New"';
            ctx.textAlign = 'center';
            if (carHealth >= 100) {
                ctx.fillStyle = '#0f0';
                ctx.fillText("READY TO ESCAPE!", carX, carY - 90);
            } else {
                ctx.fillStyle = '#ff0';
                ctx.fillText(`REPAIR: ${carHealth}%`, carX, carY - 90);
            }
            
            // Draw garage items
            garageItems.forEach(item => {
                if (!item.collected) {
                    let color = '#0f0';
                    let text = '';
                    
                    switch(item.type) {
                        case 'toolbox': color = '#ff0'; text = 'üß∞'; break;
                        case 'gasoline': color = '#f80'; text = '‚õΩ'; break;
                        case 'carbattery': color = '#0ff'; text = 'üîã'; break;
                        case 'tire': color = '#888'; text = 'üõû'; break;
                    }
                    
                    ctx.fillStyle = color;
                    ctx.font = 'bold 32px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(text, item.x, item.y);
                    
                    // Label
                    ctx.font = '14px "Courier New"';
                    ctx.fillText(item.type.toUpperCase(), item.x, item.y + 40);
                }
            });
            
            // Draw exit from garage
            ctx.fillStyle = '#666';
            ctx.fillRect(80, height/2 - 40, 60, 80);
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 16px "Courier New"';
            ctx.textAlign = 'center';
            ctx.fillText("EXIT", 110, height/2);
        }
        
        // Draw monster and helicopter on roof
        if (floor === 11) {
            // Draw helicopter
            ctx.fillStyle = helicopter.active ? '#0a0' : '#666';
            ctx.fillRect(helicopter.x - 60, helicopter.y - 30, 120, 60);
            ctx.fillStyle = '#0af';
            ctx.fillRect(helicopter.x - 40, helicopter.y - 20, 80, 40);
            
            // Helicopter blades
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(helicopter.x - 70, helicopter.y);
            ctx.lineTo(helicopter.x + 70, helicopter.y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(helicopter.x, helicopter.y - 60);
            ctx.lineTo(helicopter.x, helicopter.y + 60);
            ctx.stroke();
            
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 20px "Courier New"';
            ctx.textAlign = 'center';
            if (helicopter.active) {
                ctx.fillText("HELICOPTER", helicopter.x, helicopter.y - 80);
            } else {
                ctx.fillText("DEFEAT MONSTER", helicopter.x, helicopter.y - 80);
            }
            
            // Draw monster
            if (monster && monster.hp > 0) {
                // Monster floating animation
                monster.floatOffset += 0.01;
                const monsterFloatY = Math.sin(monster.floatOffset) * 5;
                
                ctx.save();
                ctx.translate(monster.x, monster.y + monsterFloatY);
                
                // Monster body with pulsing effect
                const monsterPulse = Math.sin(currentTime * 0.001 * 1.5) * 0.1 + 0.9;
                ctx.fillStyle = '#400';
                ctx.beginPath();
                ctx.arc(0, 0, monster.size * monsterPulse, 0, Math.PI*2);
                ctx.fill();
                
                // Monster details
                ctx.fillStyle = '#800';
                ctx.beginPath();
                ctx.arc(-25, -15, 15 * monsterPulse, 0, Math.PI*2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(25, -15, 15 * monsterPulse, 0, Math.PI*2);
                ctx.fill();
                
                // Teeth
                ctx.fillStyle = '#fff';
                for (let i = 0; i < 8; i++) {
                    ctx.fillRect(-40 + i*10, 20, 5, 15);
                }
                
                // HP bar
                ctx.fillStyle = '#300';
                ctx.fillRect(-50, -100, 100, 10);
                ctx.fillStyle = '#f00';
                ctx.fillRect(-50, -100, monster.hp/10, 10);
                
                ctx.restore();
                
                // Monster chases player
                if (!player.hidden) {
                    const dx = player.x - monster.x;
                    const dy = player.y - monster.y;
                    const dist = Math.hypot(dx, dy);
                    
                    if (dist > 50) {
                        monster.x += dx/dist * monster.speed;
                        monster.y += dy/dist * monster.speed;
                    }
                    
                    // Monster damage
                    if (dist < player.size + monster.size) {
                        player.hp -= 5;
                        updateUI();
                        
                        if (player.hp <= 0) {
                            gameOver();
                        }
                    }
                }
            }
        }
        
        // Show prompts
        const prompt = document.getElementById('prompt');
        prompt.style.display = 'none';
        
        if (inGarage) {
            // Garage prompts
            const carX = width/2;
            const carY = height/2;
            if (Math.hypot(carX - player.x, carY - player.y) < 120) {
                if (carHealth >= 100 && player.hasGarageKey) {
                    prompt.textContent = "A ‚Üí ESCAPE BY CAR";
                    prompt.style.display = 'block';
                } else if (carHealth < 100) {
                    prompt.textContent = "A ‚Üí REPAIR CAR (Use items from inventory)";
                    prompt.style.display = 'block';
                }
            }
            
            // Check garage items
            for (let item of garageItems) {
                if (!item.collected && Math.hypot(item.x - player.x, item.y - player.y) < 40) {
                    prompt.textContent = "A ‚Üí PICK UP " + item.type.toUpperCase();
                    prompt.style.display = 'block';
                    break;
                }
            }
            
            // Exit garage
            if (Math.hypot(110 - player.x, height/2 - player.y) < 50) {
                prompt.textContent = "A ‚Üí EXIT GARAGE";
                prompt.style.display = 'block';
            }
            
        } else if (floor === 11) {
            // Roof prompts
            if (helicopter.active && Math.hypot(helicopter.x - player.x, helicopter.y - player.y) < 100) {
                prompt.textContent = "A ‚Üí ESCAPE BY HELICOPTER";
                prompt.style.display = 'block';
            }
            
        } else {
            // Regular floor prompts
            // Check puzzles
            for (let p of puzzles) {
                if (!p.solved && Math.hypot(p.x - player.x, p.y - player.y) < 70) {
                    prompt.textContent = "A ‚Üí SOLVE PUZZLE";
                    prompt.style.display = 'block';
                    break;
                }
            }
            
            if (elevator && Math.hypot(elevator.x - player.x, elevator.y - player.y) < 80) {
                prompt.textContent = "A ‚Üí LIFT";
                prompt.style.display = 'block';
            } else if (stairsDown && Math.hypot(stairsDown.x - player.x, stairsDown.y - player.y) < 55) {
                prompt.textContent = "A ‚Üí DOWN";
                prompt.style.display = 'block';
            } else if (stairsUp && Math.hypot(stairsUp.x - player.x, stairsUp.y - player.y) < 55) {
                prompt.textContent = "A ‚Üí UP";
                prompt.style.display = 'block';
            } else if (nearHidingSpot && !player.hidden) {
                prompt.textContent = "A ‚Üí HIDE";
                prompt.style.display = 'block';
            } else if (player.hidden) {
                prompt.textContent = "A ‚Üí COME OUT";
                prompt.style.display = 'block';
            } else if (floor === 1 && Math.hypot(mainDoor.x - player.x, mainDoor.y - player.y) < 100) {
                prompt.textContent = "A ‚Üí MAIN DOOR";
                prompt.style.display = 'block';
            } else if (floor === 1 && Math.hypot(width - 80 - player.x, height/2 - player.y) < 60) {
                prompt.textContent = "A ‚Üí ENTER GARAGE";
                prompt.style.display = 'block';
            } else if (floor === 10 && !rope.collected && Math.hypot(rope.x - player.x, rope.y - player.y) < 60) {
                prompt.textContent = "A ‚Üí PICK UP ROPE";
                prompt.style.display = 'block';
            } else if (floor === 10 && player.hasRope && Math.hypot(width/2 - player.x, 100 - player.y) < 80) {
                prompt.textContent = "A ‚Üí USE ROPE TO ROOF";
                prompt.style.display = 'block';
            }
        }
        
    } catch (e) {
        console.error("Game loop error:", e);
    }
    
    // Continue loop
    if (gameRunning) {
        gameLoopId = requestAnimationFrame(gameLoop);
    }
}

// ============================================
// MODAL FUNCTIONS
// ============================================
let currentPuzzle = null;

function openPuzzle(puzzle) {
    currentPuzzle = puzzle;
    let questions = [];
    
    // Different puzzle difficulties based on game mode
    switch(gameMode) {
        case 'easy':
            questions = [
                {q: "3+4=?", a: "7"},
                {q: "5+6=?", a: "11"},
                {q: "9-3=?", a: "6"},
                {q: "2√ó5=?", a: "10"},
                {q: "8√∑2=?", a: "4"},
                {q: "7+8=?", a: "15"},
                {q: "12-5=?", a: "7"},
                {q: "3√ó4=?", a: "12"},
                {q: "10-7=?", a: "3"},
                {q: "6√ó2=?", a: "12"}
            ];
            break;
            
        case 'normal':
            questions = [
                {q: "7√ó9=?", a: "63"},
                {q: "15-6=?", a: "9"},
                {q: "25√∑5=?", a: "5"},
                {q: "12+18=?", a: "30"},
                {q: "8√ó8=?", a: "64"},
                {q: "3√ó7=?", a: "21"},
                {q: "14+9=?", a: "23"},
                {q: "36√∑6=?", a: "6"},
                {q: "17-8=?", a: "9"},
                {q: "5√ó6=?", a: "30"}
            ];
            break;
            
        case 'hard':
            questions = [
                {q: "13√ó7=?", a: "91"},
                {q: "48√∑6=?", a: "8"},
                {q: "17+25=?", a: "42"},
                {q: "63-28=?", a: "35"},
                {q: "9√ó12=?", a: "108"},
                {q: "81√∑9=?", a: "9"},
                {q: "34+47=?", a: "81"},
                {q: "72-36=?", a: "36"},
                {q: "15√ó8=?", a: "120"},
                {q: "96√∑8=?", a: "12"}
            ];
            break;
            
        case 'impossible':
            questions = [
                {q: "17√ó13=?", a: "221"},
                {q: "144√∑12=?", a: "12"},
                {q: "89+67=?", a: "156"},
                {q: "125-78=?", a: "47"},
                {q: "15√ó16=?", a: "240"},
                {q: "196√∑14=?", a: "14"},
                {q: "123+89=?", a: "212"},
                {q: "200-123=?", a: "77"},
                {q: "18√ó14=?", a: "252"},
                {q: "225√∑15=?", a: "15"}
            ];
            break;
    }
    
    const q = questions[Math.floor(Math.random() * questions.length)];
    document.getElementById('puzzleQuestion').textContent = q.q;
    document.getElementById('puzzleAnswer').value = '';
    document.getElementById('puzzleModal').style.display = 'flex';
    document.getElementById('puzzleAnswer').focus();
    window.currentAnswer = q.a;
}

function closePuzzle() {
    document.getElementById('puzzleModal').style.display = 'none';
    currentPuzzle = null;
}

document.getElementById('submitPuzzle').onclick = () => {
    const answer = document.getElementById('puzzleAnswer').value.trim();
    
    if (answer === window.currentAnswer && currentPuzzle) {
        currentPuzzle.solved = true;
        puzzlesSolved++;
        closePuzzle();
        
        // Give rewards based on puzzle type
        const reward = currentPuzzle.reward;
        
        // Always give health + bullet
        player.hp = Math.min(100, player.hp + 50);
        player.bullets += 1;
        
        // Give specific reward
        if (reward.type === 'key') {
            player.keys++;
            showAlert("üéâ KEY FOUND! +50% HP +1 BULLET");
        } else if (reward.type === 'carpart') {
            player.carParts++;
            addToInventory({type: 'carpart', name: reward.name});
            showAlert("üîß CAR PART FOUND! +50% HP +1 BULLET");
        } else if (reward.type === 'helicopterkey') {
            player.hasHelicopterKey = true;
            addToInventory({type: 'helicopterkey', name: reward.name});
            showAlert("üöÅ HELICOPTER KEY FOUND! +50% HP +1 BULLET");
        } else if (reward.type === 'oil') {
            player.hasOil = true;
            addToInventory({type: 'oil', name: reward.name});
            showAlert("üõ¢Ô∏è OIL FOUND! +50% HP +1 BULLET");
        } else if (reward.type === 'tape') {
            player.hasTape = true;
            addToInventory({type: 'tape', name: reward.name});
            showAlert("üìº TAPE FOUND! +50% HP +1 BULLET");
        } else if (reward.type === 'garagekey') {
            player.hasGarageKey = true;
            addToInventory({type: 'garagekey', name: reward.name});
            showAlert("üöó GARAGE KEY FOUND! +50% HP +1 BULLET");
        } else if (reward.type === 'battery') {
            battery = Math.min(100, battery + 50);
            addToInventory({type: 'battery', name: reward.name, amount: 50});
            showAlert("üîã BATTERY FOUND! +50% HP +1 BULLET");
        } else if (reward.type === 'bullets') {
            player.bullets += 10;
            addToInventory({type: 'bullets', name: reward.name, amount: 10});
            showAlert("üî´ AMMO FOUND! +50% HP +1 BULLET");
        } else if (reward.type === 'health') {
            player.hp = Math.min(100, player.hp + (reward.amount || 50));
            addToInventory({type: 'health', name: reward.name, amount: (reward.amount || 50)});
            showAlert("‚ù§Ô∏è HEALTH KIT FOUND! +" + (reward.amount || 50) + "% HP +1 BULLET");
        } else if (reward.type === 'toolbox') {
            addToInventory({type: 'toolbox', name: reward.name});
            showAlert("üß∞ TOOLBOX FOUND! +50% HP +1 BULLET");
        } else if (reward.type === 'rope') {
            addToInventory({type: 'rope', name: reward.name});
            showAlert("ü™¢ ROPE FOUND! +50% HP +1 BULLET");
        } else if (reward.type === 'maindoorkey') {
            player.hasMainDoorKey = true;
            addToInventory({type: 'maindoorkey', name: reward.name});
            showAlert("üö™ MAIN DOOR KEY FOUND! +50% HP +1 BULLET");
        }
        
        updateUI();
        updateBatteryBar();
    } else {
        showAlert("‚ùå WRONG ANSWER!");
    }
};

function openLift() {
    const container = document.getElementById('floorButtons');
    container.innerHTML = '';
    
    for (let i = 1; i <= 10; i++) {
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = 'F' + i;
        btn.style.background = i === floor ? '#c00' : '#800';
        btn.style.padding = '6px 4px';
        btn.style.fontSize = i === floor ? '1rem' : '0.9rem';
        btn.onclick = () => {
            closeLift();
            if (i !== floor) changeFloor(i);
        };
        
        container.appendChild(btn);
    }
    
    document.getElementById('liftModal').style.display = 'flex';
}

function closeLift() {
    document.getElementById('liftModal').style.display = 'none';
}

function changeFloor(to) {
    // Quick fade
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, width, height);
    
    setTimeout(() => {
        inGarage = false;
        document.getElementById('carHealthBar').style.display = 'none';
        initFloor(to);
    }, 300);
}

function showAlert(msg) {
    const alert = document.createElement('div');
    alert.style.cssText = `
        position: fixed;
        top: 40%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(100, 0, 0, 0.9);
        color: #ffd0d0;
        padding: 10px 16px;
        border-radius: 8px;
        border: 2px solid #c00;
        font-size: 1rem;
        z-index: 100000;
        text-align: center;
        max-width: 80%;
        box-shadow: 0 0 20px #800;
        font-family: 'Courier New', monospace;
        backdrop-filter: blur(5px);
    `;
    alert.textContent = msg;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 1500);
}

function carEscape() {
    gameRunning = false;
    
    // Play car engine sound
    const engineSound = document.getElementById('engineSound');
    engineSound.currentTime = 0;
    engineSound.volume = 0.7;
    engineSound.play().catch(e => console.log("Engine sound error"));
    
    // Show win screen
    setTimeout(() => {
        document.getElementById('winTitle').textContent = "CAR ESCAPE SUCCESS!";
        document.getElementById('winText').textContent = "You escaped through the garage in the car!";
        showScreen('winScreen');
        document.getElementById('bgm').pause();
    }, 2000);
}

function helicopterEscape() {
    gameRunning = false;
    
    // Play helicopter sound
    const heliSound = document.getElementById('helicopterSound');
    heliSound.currentTime = 0;
    heliSound.volume = 0.7;
    heliSound.play().catch(e => console.log("Helicopter sound error"));
    
    // Show win screen
    setTimeout(() => {
        document.getElementById('winTitle').textContent = "HELICOPTER ESCAPE SUCCESS!";
        document.getElementById('winText').textContent = "You escaped by helicopter from the roof!";
        showScreen('winScreen');
        document.getElementById('bgm').pause();
    }, 2000);
}

function mainDoorEscape() {
    gameRunning = false;
    
    document.getElementById('winTitle').textContent = "MAIN DOOR ESCAPE SUCCESS!";
    document.getElementById('winText').textContent = "You escaped through the main door!";
    showScreen('winScreen');
    document.getElementById('bgm').pause();
}

function gameOver() {
    gameRunning = false;
    showScreen('gameoverScreen');
    
    // Play scare sound
    const scare = document.getElementById('scareSound');
    scare.currentTime = 0;
    scare.play().catch(e => console.log("Scare sound error"));
    
    // Stop music
    document.getElementById('bgm').pause();
}

// ============================================
// INITIALIZATION
// ============================================
window.addEventListener('resize', () => {
    width = window.innerWidth;
    height = window.innerHeight;
    canvas.width = width;
    canvas.height = height;
    
    if (player) {
        player.x = Math.min(player.x, width - 60);
        player.y = Math.min(player.y, height - 60);
    }
    
    // Update positions
    mainDoor.x = width/2;
    mainDoor.y = height-100;
    rope.x = width-100;
    rope.y = height-150;
    helicopter.x = width/2;
    helicopter.y = 100;
    
    // Update garage item positions
    if (garageItems.length > 0) {
        garageItems[0].x = width * 0.3;
        garageItems[0].y = height * 0.7;
        garageItems[1].x = width * 0.7;
        garageItems[1].y = height * 0.7;
        garageItems[2].x = width * 0.3;
        garageItems[2].y = height * 0.3;
        garageItems[3].x = width * 0.7;
        garageItems[3].y = height * 0.3;
    }
});

// Prevent touch behaviors
document.addEventListener('touchmove', function(e) {
    if (e.target === canvas || 
        e.target === joystickArea || 
        e.target === joystick || 
        e.target.closest('#controls')) {
        e.preventDefault();
    }
}, { passive: false });

// Prevent context menu
document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    return false;
});

// Handle back button press (Android)
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' || e.key === 'Backspace') {
        e.preventDefault();
        // If in game screen, go to main menu
        if (document.getElementById('gameScreen').style.display === 'flex') {
            showScreen('startScreen');
        } else {
            exitApp();
        }
    }
});

// Initialize - Start in fullscreen
showScreen('startScreen');
console.log("CURSED APARTMENT - Complete Game with 3 Escape Routes");
</script>
</body>
</html>