<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CURSED APARTMENT - Mobile Horror Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">
<style>
    /* RESET AND BASE */
    * {
        margin: 0; 
        padding: 0; 
        box-sizing: border-box; 
        -webkit-touch-callout: none; 
        -webkit-user-select: none; 
        -moz-user-select: none; 
        -ms-user-select: none; 
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }
    
    body, html {
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #000;
        font-family: 'Courier New', monospace;
        color: #e8d8c0;
        position: fixed;
    }
    
    /* CANVAS - FULLSCREEN */
    #gameCanvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
        display: block;
        image-rendering: pixelated;
        image-rendering: crisp-edges;
    }
    
    /* SCREENS - ALWAYS FULLSCREEN */
    .screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        padding: 15px;
        overflow: hidden;
    }
    
    #startScreen {
        display: flex;
        background: radial-gradient(ellipse at center, #111122 0%, #000000 100%);
    }
    
    #modeScreen {
        display: none;
        background: linear-gradient(135deg, #0a0a1a 0%, #000000 100%);
    }
    
    #gameScreen {
        display: none;
        background: transparent;
        pointer-events: none;
    }
    
    #winScreen, #gameoverScreen {
        display: none;
        background: radial-gradient(circle at center, rgba(20, 0, 20, 0.9), #000 70%);
    }
    
    /* SCREEN CONTENT */
    .screen h1 {
        font-size: 2.8rem;
        text-shadow: 0 0 25px #ff0040, 0 0 8px #800020;
        margin-bottom: 25px;
        text-align: center;
        letter-spacing: 3px;
        color: #ffd0d0;
        font-weight: normal;
        background: linear-gradient(45deg, #ffd0d0, #ff8080);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        position: relative;
    }
    
    .screen h1::after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 180px;
        height: 3px;
        background: linear-gradient(90deg, transparent, #ff0040, transparent);
    }
    
    .btn {
        background: linear-gradient(145deg, #5a0000, #3a0000);
        color: #ffd0d0;
        border: 2px solid #a00000;
        border-radius: 8px;
        padding: 14px 25px;
        font-size: 1.2rem;
        margin: 10px;
        cursor: pointer;
        box-shadow: 0 5px 15px rgba(160, 0, 0, 0.4), 
                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
        width: 90%;
        max-width: 250px;
        text-align: center;
        font-family: 'Courier New', monospace;
        letter-spacing: 1px;
        transition: all 0.2s;
        position: relative;
        overflow: hidden;
    }
    
    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transition: left 0.5s;
    }
    
    .btn:active {
        background: linear-gradient(145deg, #7a0000, #5a0000);
        transform: translateY(2px);
        box-shadow: 0 2px 8px rgba(160, 0, 0, 0.4);
    }
    
    .btn:active::before {
        left: 100%;
    }
    
    .mode-btn {
        background: linear-gradient(145deg, #003322, #002211);
        border-color: #006644;
        box-shadow: 0 5px 15px rgba(0, 100, 68, 0.4);
    }
    
    .easy { 
        background: linear-gradient(145deg, #003322, #002211);
        border-color: #00aa66;
    }
    
    .normal { 
        background: linear-gradient(145deg, #333322, #222211);
        border-color: #aaaa00;
    }
    
    .hard { 
        background: linear-gradient(145deg, #553322, #332211);
        border-color: #ff6600;
    }
    
    .impossible { 
        background: linear-gradient(145deg, #550000, #330000);
        border-color: #ff0000;
    }
    
    /* GAME VISUAL EFFECTS */
    #torch {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle 350px at var(--x,50%) var(--y,50%), 
                    rgba(150, 120, 80, 0.4) 0%, 
                    rgba(80, 60, 40, 0.2) 30%, 
                    transparent 70%);
        opacity: 0;
        pointer-events: none;
        z-index: 2;
        mix-blend-mode: overlay;
    }
    
    #vignette {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(ellipse at center, 
                    transparent 40%, 
                    rgba(0, 0, 0, 0.9) 80%);
        pointer-events: none;
        z-index: 4;
    }
    
    #blood {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at var(--blood-x,50%) var(--blood-y,50%), 
                    rgba(200, 0, 0, 0.8) 0%, 
                    rgba(120, 0, 0, 0.4) 15%, 
                    transparent 30%);
        opacity: 0;
        pointer-events: none;
        z-index: 3;
        mix-blend-mode: multiply;
    }
    
    #hideText {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 36px;
        color: #600;
        text-shadow: 0 0 20px #f00, 0 0 5px #000;
        opacity: 0;
        z-index: 999;
        letter-spacing: 6px;
        font-weight: bold;
        font-family: 'Courier New', monospace;
    }
    
    #prompt {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(30, 0, 0, 0.85);
        border: 2px solid #a00000;
        border-radius: 8px;
        padding: 10px 20px;
        font-size: 16px;
        color: #ffd0d0;
        z-index: 999;
        display: none;
        text-align: center;
        max-width: 85%;
        backdrop-filter: blur(5px);
        box-shadow: 0 0 20px rgba(160, 0, 0, 0.5);
        font-family: 'Courier New', monospace;
    }
    
    /* MOBILE CONTROLS - SINGLE ACTION BUTTON */
    #controls {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 900;
        pointer-events: none;
        touch-action: none;
    }
    
    /* HEALTH BAR - TOP */
    #healthBar {
        position: absolute;
        top: 12px;
        left: 12px;
        right: 12px;
        height: 20px;
        background: rgba(10, 0, 0, 0.7);
        border: 2px solid #a00000;
        border-radius: 4px;
        overflow: hidden;
        backdrop-filter: blur(4px);
    }
    
    #healthFill {
        height: 100%;
        background: linear-gradient(90deg, 
                    #00ff00 0%, 
                    #aaff00 33%, 
                    #ffff00 66%, 
                    #ff0000 100%);
        width: 100%;
        transition: width 0.3s ease;
    }
    
    #healthText {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #fff;
        font-weight: bold;
        font-size: 10px;
        text-shadow: 1px 1px 2px #000;
        font-family: 'Courier New', monospace;
        letter-spacing: 0.5px;
    }
    
    /* JOYSTICK - LEFT BOTTOM (SMALLER) */
    #joystickArea {
        position: absolute;
        bottom: 15px;
        left: 15px;
        width: 100px;
        height: 100px;
        pointer-events: auto;
        z-index: 901;
    }
    
    #joystickBase {
        width: 100%;
        height: 100%;
        background: rgba(20, 0, 0, 0.6);
        border: 2px solid #600;
        border-radius: 50%;
        backdrop-filter: blur(5px);
    }
    
    #joystick {
        position: absolute;
        width: 45px;
        height: 45px;
        background: rgba(180, 0, 0, 0.8);
        border: 2px solid #c00;
        border-radius: 50%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        box-shadow: 0 0 15px rgba(200, 0, 0, 0.5);
    }
    
    /* SINGLE ACTION BUTTON - RIGHT SIDE (COMBINED HIDE/INTERACT) */
    #actionBtn {
        position: absolute;
        bottom: 15px;
        right: 15px;
        width: 65px;
        height: 65px;
        background: rgba(30, 0, 30, 0.7);
        border: 3px solid #a000a0;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #ffd0d0;
        font-size: 20px;
        font-weight: bold;
        box-shadow: 0 5px 15px rgba(160, 0, 160, 0.4);
        backdrop-filter: blur(5px);
        font-family: 'Courier New', monospace;
        pointer-events: auto;
        z-index: 901;
    }
    
    #actionBtn:active {
        background: rgba(200, 0, 200, 0.9);
        transform: scale(0.9);
    }
    
    /* SHOOT BUTTON - BULLETS SHOOT AT TOUCH POSITION (SMALLER) */
    #shootBtn {
        position: absolute;
        bottom: 90px;
        right: 15px;
        width: 65px;
        height: 65px;
        background: rgba(180, 0, 0, 0.7);
        border: 3px solid #c00;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #ffd0d0;
        font-size: 22px;
        pointer-events: auto;
        z-index: 901;
        box-shadow: 0 5px 20px rgba(200, 0, 0, 0.5);
        backdrop-filter: blur(5px);
    }
    
    #shootBtn:active {
        background: rgba(255, 50, 50, 0.9);
        transform: scale(0.9);
    }
    
    /* FLASHLIGHT TOGGLE */
    #flashlightBtn {
        position: absolute;
        top: 60px;
        right: 12px;
        width: 45px;
        height: 45px;
        background: rgba(40, 40, 0, 0.6);
        border: 2px solid #cc0;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #ff0;
        font-size: 18px;
        pointer-events: auto;
        z-index: 901;
        box-shadow: 0 5px 15px rgba(204, 204, 0, 0.4);
        backdrop-filter: blur(5px);
    }
    
    #flashlightBtn:active {
        background: rgba(80, 80, 0, 0.9);
        transform: scale(0.9);
    }
    
    /* FLOOR INDICATOR */
    #floorIndicator {
        position: absolute;
        top: 40px;
        left: 12px;
        background: rgba(10, 0, 10, 0.7);
        border: 2px solid #a000a0;
        border-radius: 6px;
        padding: 4px 8px;
        color: #f0c0f0;
        font-size: 12px;
        font-weight: bold;
        z-index: 902;
        backdrop-filter: blur(4px);
        font-family: 'Courier New', monospace;
    }
    
    /* QUIT BUTTON - TOP RIGHT (SMALLER) */
    #quitBtn {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 45px;
        height: 45px;
        background: rgba(40, 0, 0, 0.7);
        border: 2px solid #c00;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #ffd0d0;
        font-size: 18px;
        pointer-events: auto;
        z-index: 902;
        box-shadow: 0 5px 15px rgba(200, 0, 0, 0.4);
        backdrop-filter: blur(5px);
    }
    
    #quitBtn:active {
        background: rgba(200, 0, 0, 0.9);
        transform: scale(0.9);
    }
    
    /* MODALS */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.92);
        z-index: 10000;
        display: none;
        justify-content: center;
        align-items: center;
        padding: 15px;
    }
    
    .modal-content {
        background: linear-gradient(145deg, #1a001a, #0a000a);
        padding: 15px;
        border-radius: 10px;
        border: 3px solid #a000a0;
        text-align: center;
        max-width: 95%;
        width: 350px;
        box-shadow: 0 0 40px rgba(160, 0, 160, 0.6);
        position: relative;
        overflow: hidden;
    }
    
    .modal-content::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, transparent, #ff00ff, transparent);
    }
    
    /* RESPONSIVE */
    @media (max-width: 480px) {
        .screen h1 {
            font-size: 2.2rem;
        }
        
        .btn {
            font-size: 1rem;
            padding: 12px 18px;
            max-width: 220px;
            margin: 8px;
        }
        
        #joystickArea {
            width: 90px;
            height: 90px;
            bottom: 12px;
            left: 12px;
        }
        
        #joystick {
            width: 40px;
            height: 40px;
        }
        
        #actionBtn {
            width: 60px;
            height: 60px;
            font-size: 18px;
            bottom: 12px;
            right: 12px;
        }
        
        #shootBtn {
            width: 60px;
            height: 60px;
            bottom: 85px;
            right: 12px;
            font-size: 20px;
        }
        
        #flashlightBtn {
            width: 40px;
            height: 40px;
            font-size: 16px;
            top: 55px;
            right: 10px;
        }
        
        #quitBtn {
            width: 40px;
            height: 40px;
            font-size: 16px;
            top: 10px;
            right: 10px;
        }
        
        #healthBar {
            height: 18px;
            top: 10px;
            left: 10px;
            right: 10px;
        }
        
        #healthText {
            font-size: 9px;
        }
        
        #floorIndicator {
            top: 35px;
            left: 10px;
            font-size: 11px;
            padding: 3px 6px;
        }
        
        #hideText {
            font-size: 32px;
        }
        
        #prompt {
            font-size: 14px;
            padding: 8px 16px;
        }
        
        .modal-content {
            padding: 12px;
            width: 320px;
        }
    }
    
    @media (min-width: 768px) and (orientation: landscape) {
        #joystickArea {
            width: 95px;
            height: 95px;
        }
        
        #joystick {
            width: 42px;
            height: 42px;
        }
        
        #actionBtn, #shootBtn {
            width: 60px;
            height: 60px;
        }
        
        #flashlightBtn, #quitBtn {
            width: 45px;
            height: 45px;
        }
    }
</style>
</head>
<body>
<!-- SCREENS -->
<div id="startScreen" class="screen">
    <h1>CURSED APARTMENT</h1>
    
    <div style="font-size: 0.9rem; text-align: center; margin: 12px; background: rgba(30, 0, 30, 0.6); padding: 12px; border-radius: 8px; border: 1px solid #600060; max-width: 90%;">
        <div style="color: #a0f0ff; font-weight: bold; margin-bottom: 6px; font-size: 1rem;">üéØ FIND 5 KEYS ‚Üí ESCAPE 10F DOOR!</div>
        <div style="margin: 5px 0;"><span style="color: #0f0">JOYSTICK:</span> MOVE</div>
        <div style="margin: 5px 0;"><span style="color: #f80">üî´ BUTTON:</span> SHOOT (Touch to aim)</div>
        <div style="margin: 5px 0;"><span style="color: #ff0">A BUTTON:</span> HIDE/INTERACT (Near hide spots)</div>
        <div style="margin: 5px 0;"><span style="color: #cc0">üî¶ ICON:</span> FLASHLIGHT</div>
        <div style="margin: 5px 0;"><span style="color: #f0f">‚ùå ICON:</span> EXIT APP</div>
    </div>
    
    <button class="btn" id="startBtn">SELECT MODE</button>
</div>

<div id="modeScreen" class="screen">
    <h1>SELECT DIFFICULTY</h1>
    <button class="btn mode-btn easy" data-mode="easy">EASY</button>
    <button class="btn mode-btn normal" data-mode="normal">NORMAL</button>
    <button class="btn mode-btn hard" data-mode="hard">HARD</button>
    <button class="btn mode-btn impossible" data-mode="impossible">IMPOSSIBLE</button>
    <button class="btn" id="backBtn">BACK</button>
</div>

<div id="gameScreen" class="screen"></div>

<div id="winScreen" class="screen">
    <h1>YOU ESCAPED!</h1>
    <p style="font-size: 1.3rem; margin: 15px; text-align: center; color: #a0ffa0;">Freedom at last...</p>
    <button class="btn" onclick="location.reload()">PLAY AGAIN</button>
</div>

<div id="gameoverScreen" class="screen">
    <h1>YOU DIED</h1>
    <p style="font-size: 1.3rem; margin: 15px; text-align: center; color: #ffa0a0;">The darkness consumed you...</p>
    <button class="btn" onclick="location.reload()">TRY AGAIN</button>
</div>

<!-- CANVAS -->
<canvas id="gameCanvas"></canvas>

<!-- GAME EFFECTS -->
<div id="torch"></div>
<div id="vignette"></div>
<div id="blood"></div>
<div id="hideText">HIDING...</div>
<div id="prompt"></div>

<!-- MOBILE CONTROLS -->
<div id="controls">
    <div id="healthBar">
        <div id="healthFill"></div>
        <div id="healthText">HP: 100 | KEYS: 0/5 | BULLETS: 10</div>
    </div>
    
    <div id="floorIndicator">FLOOR: 1</div>
    
    <div id="quitBtn">‚ùå</div>
    
    <div id="joystickArea">
        <div id="joystickBase"></div>
        <div id="joystick"></div>
    </div>
    
    <div id="shootBtn">üî´</div>
    
    <div id="actionBtn">A</div>
    
    <div id="flashlightBtn">üî¶</div>
</div>

<!-- MODALS -->
<div id="puzzleModal" class="modal">
    <div class="modal-content">
        <h2 style="color: #f99; margin-bottom: 12px; font-size: 1.6rem;">SOLVE PUZZLE</h2>
        <p id="puzzleQuestion" style="font-size: 1.4rem; color: #0ff; margin: 12px 0; min-height: 50px; display: flex; align-items: center; justify-content: center;"></p>
        <input type="text" id="puzzleAnswer" style="width: 100%; padding: 8px; font-size: 1.1rem; text-align: center; background: #111; color: #fff; border: 2px solid #600; border-radius: 6px; margin: 8px 0;" placeholder="Enter answer...">
        <div style="display: flex; gap: 6px; margin-top: 12px;">
            <button id="submitPuzzle" class="btn" style="flex: 1; padding: 8px; font-size: 1rem;">SUBMIT</button>
            <button onclick="closePuzzle()" class="btn" style="background: #400; border-color: #600; padding: 8px; font-size: 1rem;">CANCEL</button>
        </div>
    </div>
</div>

<div id="liftModal" class="modal">
    <div class="modal-content">
        <h2 style="color: #0ff; margin-bottom: 12px; font-size: 1.6rem;">SELECT FLOOR</h2>
        <div id="floorButtons" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin: 12px 0;"></div>
        <button onclick="closeLift()" class="btn" style="width: 100%; font-size: 1rem;">CANCEL</button>
    </div>
</div>

<!-- AUDIO -->
<audio id="bgm" loop src="https://assets.codepen.io/605876/creepy-horror-ambience.mp3"></audio>
<audio id="gunSound" src="https://assets.codepen.io/605876/gunshot.mp3"></audio>
<audio id="hitSound" src="https://assets.codepen.io/605876/hit-marker.mp3"></audio>
<audio id="scareSound" src="https://assets.codepen.io/605876/jumpscare-scream.mp3"></audio>

<script>
// ============================================
// FULLSCREEN MANAGEMENT - ALWAYS FULLSCREEN
// ============================================
function requestFullscreen() {
    const elem = document.documentElement;
    
    if (elem.requestFullscreen) {
        elem.requestFullscreen();
    } else if (elem.webkitRequestFullscreen) { /* Safari */
        elem.webkitRequestFullscreen();
    } else if (elem.msRequestFullscreen) { /* IE11 */
        elem.msRequestFullscreen();
    }
    
    // Hide browser UI on mobile
    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        setTimeout(() => {
            window.scrollTo(0, 1);
        }, 100);
    }
}

function exitFullscreen() {
    if (document.exitFullscreen) {
        document.exitFullscreen();
    } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
    } else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen();
    } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
    }
}

// Automatically go fullscreen on page load
window.addEventListener('load', () => {
    setTimeout(() => {
        requestFullscreen();
    }, 500);
});

// Also go fullscreen when orientation changes
window.addEventListener('orientationchange', () => {
    setTimeout(() => {
        requestFullscreen();
    }, 300);
});

// ============================================
// APP EXIT FUNCTION - CLOSE APP
// ============================================
function exitApp() {
    // Try different methods to close the app/browser
    if (navigator.app && navigator.app.exitApp) {
        // For Cordova/PhoneGap
        navigator.app.exitApp();
    } else if (navigator.device && navigator.device.exitApp) {
        // For other hybrid apps
        navigator.device.exitApp();
    } else {
        // For browsers - close window or tab
        if (window.history.length > 1) {
            window.history.back();
        } else {
            // Try to close the window/tab
            window.close();
            
            // If window.close doesn't work, redirect to about:blank
            setTimeout(() => {
                window.location.href = 'about:blank';
            }, 1000);
            
            // Show message
            alert("Tap back button again to exit");
        }
    }
}

// ============================================
// GAME VARIABLES
// ============================================
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let width = window.innerWidth;
let height = window.innerHeight;
canvas.width = width;
canvas.height = height;

let gameMode = 'easy';
let player = {
    x: width/2,
    y: height/2,
    hp: 100,
    keys: 0,
    bullets: 10,
    vx: 0,
    vy: 0,
    speed: 4.0, // Increased player speed
    hidden: false,
    size: 18,
    hidingSpot: null
};
let floor = 1, torchOn = false, battery = 100;
let ghosts = [], puzzle = null, stairsUp = null, stairsDown = null, elevator = null, exitDoor = null, hidingSpots = [];
let bullets = [], batteryGiven = false;
let gameRunning = false;
let gameLoopId = null;

// Puzzle tracking - first 5 puzzles have keys, next 5 have other rewards
let puzzlesSolved = 0;
const puzzleRewards = [
    { type: 'key' },
    { type: 'key' },
    { type: 'key' },
    { type: 'key' },
    { type: 'key' },
    { type: 'battery', amount: 50 },
    { type: 'battery', amount: 50 },
    { type: 'battery', amount: 50 },
    { type: 'battery', amount: 50 },
    { type: 'battery', amount: 50 },
    { type: 'bullets', amount: 10 },
    { type: 'bullets', amount: 10 },
    { type: 'bullets', amount: 10 },
    { type: 'bullets', amount: 10 },
    { type: 'bullets', amount: 10 }
];

// Joystick variables
let joystickActive = false;
let joystickX = 0;
let joystickY = 0;
let joystickStartX = 0;
let joystickStartY = 0;
const JOYSTICK_RADIUS = 35;

// Shoot aiming variables
let shootTouchX = 0;
let shootTouchY = 0;

// Hide variables
let nearHidingSpot = false;

// ============================================
// SCREEN MANAGEMENT - ALWAYS FULLSCREEN
// ============================================
function showScreen(screenId) {
    // Hide all screens
    ['startScreen','modeScreen','gameScreen','winScreen','gameoverScreen'].forEach(id => {
        document.getElementById(id).style.display = 'none';
    });
    
    // Show requested screen
    document.getElementById(screenId).style.display = 'flex';
    
    // Make sure we're in fullscreen
    requestFullscreen();
    
    // Handle game screen
    if (screenId === 'gameScreen') {
        // Show game elements
        canvas.style.display = 'block';
        document.getElementById('controls').style.display = 'block';
        document.getElementById('torch').style.display = 'block';
        document.getElementById('vignette').style.display = 'block';
        document.getElementById('blood').style.display = 'block';
        document.getElementById('hideText').style.display = 'block';
        document.getElementById('prompt').style.display = 'block';
        
        // Start game
        if (!gameRunning) {
            startGame();
        }
    } else {
        // Hide game elements
        canvas.style.display = 'none';
        document.getElementById('controls').style.display = 'none';
        document.getElementById('torch').style.display = 'none';
        document.getElementById('vignette').style.display = 'none';
        document.getElementById('blood').style.display = 'none';
        document.getElementById('hideText').style.display = 'none';
        document.getElementById('prompt').style.display = 'none';
        
        // Stop game
        if (gameRunning) {
            gameRunning = false;
            if (gameLoopId) cancelAnimationFrame(gameLoopId);
            document.getElementById('bgm').pause();
        }
    }
}

// ============================================
// GAME INITIALIZATION
// ============================================
document.getElementById('startBtn').onclick = () => showScreen('modeScreen');
document.getElementById('backBtn').onclick = () => showScreen('startScreen');

document.querySelectorAll('.mode-btn').forEach(btn => {
    btn.onclick = function() {
        gameMode = this.dataset.mode;
        showScreen('gameScreen');
    };
});

function startGame() {
    console.log("Starting game in", gameMode, "mode");
    
    // Stop any existing game
    if (gameLoopId) {
        cancelAnimationFrame(gameLoopId);
        gameLoopId = null;
    }
    
    // Reset game state
    gameRunning = true;
    player = {
        x: width/2,
        y: height/2,
        hp: 100,
        keys: 0,
        bullets: 10,
        vx: 0,
        vy: 0,
        speed: 4.0, // Increased player speed
        hidden: false,
        size: 18,
        hidingSpot: null
    };
    floor = 1;
    torchOn = false;
    battery = 100;
    ghosts = [];
    puzzle = null;
    stairsUp = null;
    stairsDown = null;
    elevator = null;
    exitDoor = null;
    hidingSpots = [];
    bullets = [];
    batteryGiven = false;
    puzzlesSolved = 0;
    
    // Update UI
    updateUI();
    updateFloorIndicator();
    
    // Start audio
    const bgm = document.getElementById('bgm');
    bgm.volume = 0.5;
    bgm.currentTime = 0;
    bgm.play().catch(e => console.log("Audio error:", e));
    
    // Initialize first floor
    initFloor(1);
    
    // Start game loop
    gameLoop();
}

// ============================================
// MOBILE CONTROLS - SINGLE ACTION BUTTON
// ============================================
// Quit Button - EXIT APP
document.getElementById('quitBtn').addEventListener('touchstart', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    // Exit the app completely
    exitApp();
}, { passive: false });

// Joystick
const joystickArea = document.getElementById('joystickArea');
const joystick = document.getElementById('joystick');

joystickArea.addEventListener('touchstart', function(e) {
    e.preventDefault();
    e.stopPropagation();
    if (!gameRunning) return;
    
    joystickActive = true;
    const touch = e.touches[0];
    const rect = joystickArea.getBoundingClientRect();
    joystickStartX = rect.left + rect.width/2;
    joystickStartY = rect.top + rect.height/2;
    
    updateJoystick(touch.clientX, touch.clientY);
}, { passive: false });

joystickArea.addEventListener('touchmove', function(e) {
    e.preventDefault();
    e.stopPropagation();
    if (!joystickActive || !gameRunning) return;
    
    const touch = e.touches[0];
    updateJoystick(touch.clientX, touch.clientY);
}, { passive: false });

joystickArea.addEventListener('touchend', function(e) {
    e.preventDefault();
    e.stopPropagation();
    joystickActive = false;
    joystickX = 0;
    joystickY = 0;
    joystick.style.transform = 'translate(-50%, -50%)';
});

function updateJoystick(touchX, touchY) {
    let dx = touchX - joystickStartX;
    let dy = touchY - joystickStartY;
    const distance = Math.sqrt(dx*dx + dy*dy);
    
    if (distance > JOYSTICK_RADIUS) {
        dx = (dx/distance) * JOYSTICK_RADIUS;
        dy = (dy/distance) * JOYSTICK_RADIUS;
    }
    
    joystickX = dx;
    joystickY = dy;
    joystick.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
}

// SHOOT BUTTON - AIM WITH TOUCH POSITION
const shootBtn = document.getElementById('shootBtn');
let shootBtnRect = null;

// Update shoot button position on resize
function updateShootBtnPosition() {
    shootBtnRect = shootBtn.getBoundingClientRect();
}

// Initial position update
updateShootBtnPosition();

// Listen for touch on shoot button
shootBtn.addEventListener('touchstart', function(e) {
    e.preventDefault();
    e.stopPropagation();
    if (!gameRunning || player.bullets <= 0) return;
    
    const touch = e.touches[0];
    
    // Store the touch position for aiming
    shootTouchX = touch.clientX;
    shootTouchY = touch.clientY;
    
    // Calculate bullet direction based on touch position
    const bulletDirectionX = shootTouchX - player.x;
    const bulletDirectionY = shootTouchY - player.y;
    const distance = Math.sqrt(bulletDirectionX * bulletDirectionX + bulletDirectionY * bulletDirectionY);
    
    // Normalize direction
    const dirX = bulletDirectionX / distance;
    const dirY = bulletDirectionY / distance;
    
    // Calculate target position (shoot towards touch point)
    const targetX = player.x + dirX * 500;
    const targetY = player.y + dirY * 500;
    
    // Shoot bullet
    shootBullet(targetX, targetY);
    
}, { passive: false });

// Shoot bullet function
function shootBullet(targetX, targetY) {
    player.bullets--;
    updateUI();
    
    // Play gun sound
    const gunSound = document.getElementById('gunSound');
    gunSound.currentTime = 0;
    gunSound.play().catch(e => console.log("Gun sound error"));
    
    // Create bullet shooting towards target
    bullets.push({
        x: player.x,
        y: player.y,
        tx: targetX,
        ty: targetY,
        life: 40
    });
    
    // Check hit with ghosts
    ghosts = ghosts.filter(g => {
        // Calculate distance from bullet line to ghost
        const bulletStartX = player.x;
        const bulletStartY = player.y;
        const bulletEndX = player.x + (targetX - player.x) * 0.3;
        const bulletEndY = player.y + (targetY - player.y) * 0.3;
        
        // Simple collision check - if ghost is near the bullet path
        const distanceToLine = pointToLineDistance(g.x, g.y, bulletStartX, bulletStartY, bulletEndX, bulletEndY);
        
        if (distanceToLine < 50) { // Ghost hit radius
            // Hit sound
            document.getElementById('hitSound').currentTime = 0;
            document.getElementById('hitSound').play().catch(e => console.log("Hit sound error"));
            
            // Blood effect
            document.getElementById('blood').style.setProperty('--blood-x', g.x + 'px');
            document.getElementById('blood').style.setProperty('--blood-y', g.y + 'px');
            document.getElementById('blood').style.opacity = 1;
            setTimeout(() => {
                document.getElementById('blood').style.opacity = 0;
            }, 500);
            
            // Blood particles
            for (let i = 0; i < 6; i++) {
                bullets.push({
                    x: g.x,
                    y: g.y,
                    tx: g.x + (Math.random()-0.5)*150,
                    ty: g.y + (Math.random()-0.5)*150,
                    life: 20,
                    blood: true
                });
            }
            
            return false; // Remove ghost
        }
        return true;
    });
}

// Calculate distance from point to line
function pointToLineDistance(px, py, x1, y1, x2, y2) {
    const A = px - x1;
    const B = py - y1;
    const C = x2 - x1;
    const D = y2 - y1;

    const dot = A * C + B * D;
    const lenSq = C * C + D * D;
    let param = -1;
    
    if (lenSq !== 0) {
        param = dot / lenSq;
    }

    let xx, yy;

    if (param < 0) {
        xx = x1;
        yy = y1;
    } else if (param > 1) {
        xx = x2;
        yy = y2;
    } else {
        xx = x1 + param * C;
        yy = y1 + param * D;
    }

    const dx = px - xx;
    const dy = py - yy;
    
    return Math.sqrt(dx * dx + dy * dy);
}

// SINGLE ACTION BUTTON - HIDE/INTERACT
const actionBtn = document.getElementById('actionBtn');

actionBtn.addEventListener('touchstart', function(e) {
    e.preventDefault();
    e.stopPropagation();
    if (!gameRunning) return;
    
    if (player.hidden) {
        // If already hiding, come out of hiding
        player.hidden = false;
        player.hidingSpot = null;
        document.getElementById('hideText').style.opacity = 0;
        
        // Reset ghost movement
        ghosts.forEach(g => {
            g.wandering = false;
        });
    } else if (nearHidingSpot) {
        // If near hiding spot, hide
        player.hidden = true;
        document.getElementById('hideText').style.opacity = 1;
        
        // Find the nearest hiding spot
        let closestSpot = null;
        let closestDistance = Infinity;
        
        hidingSpots.forEach(spot => {
            const dist = Math.hypot(spot.x - player.x, spot.y - player.y);
            if (dist < 60 && dist < closestDistance) {
                closestDistance = dist;
                closestSpot = spot;
            }
        });
        
        if (closestSpot) {
            player.hidingSpot = closestSpot;
            player.x = closestSpot.x;
            player.y = closestSpot.y;
        }
        
        // Make ghosts wander randomly
        ghosts.forEach(g => {
            g.wandering = true;
            g.wanderTargetX = g.x + (Math.random()-0.5)*200;
            g.wanderTargetY = g.y + (Math.random()-0.5)*200;
        });
        
        setTimeout(() => {
            document.getElementById('hideText').style.opacity = 0;
        }, 1500);
    } else {
        // Otherwise, interact with other objects
        // Check elevator
        if (elevator && Math.hypot(elevator.x - player.x, elevator.y - player.y) < 90) {
            openLift();
            return;
        }
        
        // Check puzzle
        if (puzzle && !puzzle.solved && Math.hypot(puzzle.x - player.x, puzzle.y - player.y) < 70) {
            openPuzzle();
            return;
        }
        
        // Check stairs
        if (stairsDown && Math.hypot(stairsDown.x - player.x, stairsDown.y - player.y) < 60) {
            changeFloor(stairsDown.to);
            return;
        }
        
        if (stairsUp && Math.hypot(stairsUp.x - player.x, stairsUp.y - player.y) < 60) {
            changeFloor(stairsUp.to);
            return;
        }
        
        // Check exit
        if (exitDoor && player.keys >= 5 && Math.hypot(exitDoor.x - player.x, exitDoor.y - player.y) < 100) {
            winGame();
            return;
        }
    }
}, { passive: false });

// Flashlight Button
document.getElementById('flashlightBtn').addEventListener('touchstart', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    torchOn = !torchOn;
    const btn = document.getElementById('flashlightBtn');
    btn.style.background = torchOn ? 'rgba(100,100,0,0.9)' : 'rgba(40,40,0,0.6)';
    btn.style.borderColor = torchOn ? '#ff0' : '#cc0';
}, { passive: false });

// ============================================
// GAME LOGIC
// ============================================
function initFloor(f) {
    floor = f;
    ghosts = [];
    puzzle = null;
    stairsUp = null;
    stairsDown = null;
    elevator = null;
    exitDoor = null;
    hidingSpots = [];
    bullets = [];
    
    // Ghost settings based on difficulty
    let ghostCount = 4;
    let ghostSpeed = 1.4; // Increased ghost speed
    let ghostDamage = 0.3;
    
    switch(gameMode) {
        case 'easy': 
            ghostCount = 3; 
            ghostSpeed = 1.0; 
            ghostDamage = 0.2; 
            break;
        case 'normal': 
            ghostCount = 4; 
            ghostSpeed = 1.4; 
            ghostDamage = 0.3; 
            break;
        case 'hard': 
            ghostCount = 5; 
            ghostSpeed = 1.8; 
            ghostDamage = 0.5; 
            break;
        case 'impossible': 
            ghostCount = 6; 
            ghostSpeed = 2.2; 
            ghostDamage = 0.8; 
            break;
    }
    
    // Create ghosts
    for (let i = 0; i < ghostCount; i++) {
        ghosts.push({
            x: 100 + Math.random()*(width-200),
            y: 100 + Math.random()*(height-200),
            speed: ghostSpeed + Math.random()*0.5,
            damage: ghostDamage,
            size: 30,
            wandering: false,
            wanderTargetX: 0,
            wanderTargetY: 0
        });
    }
    
    // Puzzle - check which reward to give based on puzzles solved
    const rewardIndex = puzzlesSolved % puzzleRewards.length;
    const reward = puzzleRewards[rewardIndex];
    
    puzzle = {
        x: width/2,
        y: height/2,
        solved: false,
        rewardType: reward.type,
        rewardAmount: reward.amount || 1
    };
    
    // Elevator and stairs
    elevator = {x: width/2, y: height-100};
    if (f > 1) stairsDown = {x: 70, y: height/2, to: f-1};
    if (f < 10) stairsUp = {x: width-70, y: height/2, to: f+1};
    if (f === 10) exitDoor = {x: width/2, y: 90};
    
    // Hiding spots
    hidingSpots = [
        {x: 70, y: 90},
        {x: 70, y: height-90},
        {x: width-70, y: 90},
        {x: width-70, y: height-90}
    ];
    
    updateFloorIndicator();
    updateUI();
}

function updateUI() {
    document.getElementById('healthFill').style.width = player.hp + '%';
    document.getElementById('healthText').textContent = 
        `HP: ${Math.floor(player.hp)} | KEYS: ${player.keys}/5 | BULLETS: ${player.bullets}`;
}

function updateFloorIndicator() {
    document.getElementById('floorIndicator').textContent = `FLOOR: ${floor}`;
}

// ============================================
// GAME LOOP
// ============================================
function gameLoop() {
    if (!gameRunning) return;
    
    try {
        // Clear canvas
        ctx.fillStyle = '#0a0a0a';
        ctx.fillRect(0, 0, width, height);
        
        // Draw walls
        ctx.fillStyle = '#1a1a1a';
        ctx.fillRect(0, 0, width, 50);
        ctx.fillRect(0, height-50, width, 50);
        ctx.fillRect(0, 0, 50, height);
        ctx.fillRect(width-50, 0, 50, height);
        
        // Player movement (only if not hidden)
        if (!player.hidden) {
            if (joystickActive) {
                const moveX = joystickX / JOYSTICK_RADIUS;
                const moveY = joystickY / JOYSTICK_RADIUS;
                player.vx = moveX * player.speed;
                player.vy = moveY * player.speed;
            } else {
                player.vx *= 0.8;
                player.vy *= 0.8;
            }
            
            player.x += player.vx;
            player.y += player.vy;
            
            // Keep player in bounds
            player.x = Math.max(60, Math.min(width-60, player.x));
            player.y = Math.max(60, Math.min(height-60, player.y));
        }
        
        // Draw bullets
        for (let i = bullets.length-1; i >= 0; i--) {
            const b = bullets[i];
            const dx = b.tx - b.x;
            const dy = b.ty - b.y;
            const dist = Math.hypot(dx, dy);
            
            if (dist < 15 || b.life-- <= 0) {
                bullets.splice(i, 1);
                continue;
            }
            
            b.x += dx/dist * 22;
            b.y += dy/dist * 22;
            
            ctx.strokeStyle = b.blood ? '#f00' : '#ff0';
            ctx.lineWidth = b.blood ? 3 : 4;
            ctx.beginPath();
            ctx.moveTo(b.x, b.y);
            ctx.lineTo(b.x + dx*0.3, b.y + dy*0.3);
            ctx.stroke();
            
            // Glow effect for normal bullets
            if (!b.blood) {
                ctx.shadowColor = '#ff0';
                ctx.shadowBlur = 8;
                ctx.stroke();
                ctx.shadowBlur = 0;
            }
        }
        
        // Torch effect
        const torch = document.getElementById('torch');
        torch.style.opacity = torchOn && battery > 0 ? 1 : 0;
        if (torchOn && battery > 0) {
            battery -= 0.04;
            if (battery <= 0) {
                torchOn = false;
                battery = 0;
            }
        }
        
        // Update torch position
        torch.style.setProperty('--x', player.x + 'px');
        torch.style.setProperty('--y', player.y + 'px');
        
        // Draw player
        const size = player.size;
        ctx.fillStyle = player.hidden ? '#333' : '#fff';
        ctx.fillRect(player.x - size/2, player.y - size, size, size*2);
        
        // Player details
        ctx.fillStyle = '#000';
        ctx.fillRect(player.x - size/3, player.y - size*0.7, size*0.66, size*0.4);
        
        // Arms
        ctx.fillStyle = player.hidden ? '#222' : '#c66';
        ctx.fillRect(player.x - size*0.8, player.y, size*0.6, size*0.8);
        ctx.fillRect(player.x + size*0.2, player.y, size*0.6, size*0.8);
        
        // Check if player is near a hiding spot
        nearHidingSpot = false;
        hidingSpots.forEach(spot => {
            const dist = Math.hypot(spot.x - player.x, spot.y - player.y);
            if (dist < 60 && !player.hidden) {
                nearHidingSpot = true;
            }
        });
        
        // Update and draw ghosts
        for (const g of ghosts) {
            if (player.hidden) {
                // If player is hidden, ghosts wander randomly
                if (g.wandering) {
                    const dx = g.wanderTargetX - g.x;
                    const dy = g.wanderTargetY - g.y;
                    const dist = Math.hypot(dx, dy);
                    
                    if (dist < 30) {
                        // Set new random wander target
                        g.wanderTargetX = g.x + (Math.random()-0.5)*300;
                        g.wanderTargetY = g.y + (Math.random()-0.5)*300;
                    } else {
                        g.x += dx/dist * (g.speed * 0.5);
                        g.y += dy/dist * (g.speed * 0.5);
                    }
                }
            } else {
                // If player is not hidden, ghosts chase player
                const dx = player.x - g.x;
                const dy = player.y - g.y;
                const dist = Math.hypot(dx, dy);
                
                if (dist > 25) {
                    g.x += dx/dist * g.speed;
                    g.y += dy/dist * g.speed;
                }
            }
            
            // Draw ghost body
            ctx.fillStyle = '#111';
            ctx.beginPath();
            ctx.arc(g.x, g.y, g.size, 0, Math.PI*2);
            ctx.fill();
            
            // Glow effect
            ctx.shadowColor = '#f00';
            ctx.shadowBlur = 12;
            ctx.fill();
            ctx.shadowBlur = 0;
            
            // Eyes
            ctx.fillStyle = '#300';
            ctx.beginPath();
            ctx.arc(g.x - 10, g.y - 8, 6, 0, Math.PI*2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(g.x + 10, g.y - 8, 6, 0, Math.PI*2);
            ctx.fill();
            
            // Pupils
            ctx.fillStyle = '#f00';
            ctx.beginPath();
            ctx.arc(g.x - 10, g.y - 8, 3, 0, Math.PI*2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(g.x + 10, g.y - 8, 3, 0, Math.PI*2);
            ctx.fill();
            
            // Damage player (only if not hidden)
            if (Math.hypot(g.x - player.x, g.y - player.y) < size + g.size && !player.hidden) {
                player.hp -= g.damage;
                document.getElementById('blood').style.opacity = 1;
                setTimeout(() => {
                    document.getElementById('blood').style.opacity = 0;
                }, 300);
                
                if (player.hp <= 0) {
                    player.hp = 0;
                    gameOver();
                }
                
                updateUI();
            }
        }
        
        // Draw hiding spots
        hidingSpots.forEach(s => {
            const isCurrentHidingSpot = player.hidingSpot && s.x === player.hidingSpot.x && s.y === player.hidingSpot.y;
            ctx.fillStyle = isCurrentHidingSpot ? '#003300' : '#222';
            ctx.fillRect(s.x - 40, s.y - 50, 80, 100);
            
            // Cabinet doors
            ctx.fillStyle = isCurrentHidingSpot ? '#112211' : '#433';
            ctx.fillRect(s.x - 32, s.y - 40, 28, 80);
            ctx.fillRect(s.x + 4, s.y - 40, 28, 80);
            
            // Label
            ctx.fillStyle = '#0f0';
            ctx.font = '12px "Courier New"';
            ctx.textAlign = 'center';
            ctx.fillText("HIDE", s.x, s.y);
        });
        
        // Draw puzzle
        if (puzzle) {
            const color = puzzle.solved ? '#0f0' : '#ff0';
            ctx.fillStyle = color;
            ctx.fillRect(puzzle.x - 40, puzzle.y - 40, 80, 80);
            ctx.fillStyle = '#000';
            ctx.fillRect(puzzle.x - 28, puzzle.y - 28, 56, 56);
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 16px "Courier New"';
            ctx.textAlign = 'center';
            
            let rewardText = "";
            if (puzzle.rewardType === 'key') rewardText = "KEY";
            else if (puzzle.rewardType === 'battery') rewardText = "BATTERY";
            else if (puzzle.rewardType === 'bullets') rewardText = "BULLETS";
            
            ctx.fillText(puzzle.solved ? "SOLVED" : rewardText, puzzle.x, puzzle.y + 5);
            
            // Glow effect
            ctx.shadowColor = color;
            ctx.shadowBlur = 15;
            ctx.fillRect(puzzle.x - 40, puzzle.y - 40, 80, 80);
            ctx.shadowBlur = 0;
        }
        
        // Draw elevator
        if (elevator) {
            ctx.fillStyle = '#333';
            ctx.fillRect(elevator.x - 50, elevator.y - 50, 100, 100);
            ctx.fillStyle = '#0ff';
            ctx.font = 'bold 18px "Courier New"';
            ctx.textAlign = 'center';
            ctx.fillText("LIFT", elevator.x, elevator.y - 12);
        }
        
        // Draw stairs
        if (stairsDown) {
            ctx.fillStyle = '#444';
            ctx.fillRect(stairsDown.x - 35, stairsDown.y - 40, 70, 80);
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 22px "Courier New"';
            ctx.textAlign = 'center';
            ctx.fillText("DN", stairsDown.x, stairsDown.y + 6);
        }
        
        if (stairsUp) {
            ctx.fillStyle = '#444';
            ctx.fillRect(stairsUp.x - 35, stairsUp.y - 40, 70, 80);
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 22px "Courier New"';
            ctx.textAlign = 'center';
            ctx.fillText("UP", stairsUp.x, stairsUp.y + 6);
        }
        
        // Draw exit door
        if (exitDoor) {
            if (player.keys >= 5) {
                ctx.fillStyle = '#c00';
                ctx.fillRect(exitDoor.x - 70, exitDoor.y - 80, 140, 160);
                ctx.fillStyle = '#000';
                ctx.fillRect(exitDoor.x - 50, exitDoor.y - 40, 100, 80);
                
                // Animated effect
                const time = Date.now() * 0.005;
                for (let i = 0; i < 10; i++) {
                    const a = time + i * 0.3;
                    ctx.strokeStyle = '#f00';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(exitDoor.x, exitDoor.y, 40 + i * 7, a, a + 2.0);
                    ctx.stroke();
                }
                
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 26px "Courier New"';
                ctx.textAlign = 'center';
                ctx.fillText("EXIT", exitDoor.x, exitDoor.y + 8);
            } else {
                ctx.fillStyle = '#400';
                ctx.fillRect(exitDoor.x - 70, exitDoor.y - 80, 140, 160);
                ctx.fillStyle = '#822';
                ctx.font = 'bold 20px "Courier New"';
                ctx.textAlign = 'center';
                ctx.fillText("LOCKED", exitDoor.x, exitDoor.y + 8);
            }
        }
        
        // Show prompts
        const prompt = document.getElementById('prompt');
        prompt.style.display = 'none';
        
        if (elevator && Math.hypot(elevator.x - player.x, elevator.y - player.y) < 80) {
            prompt.textContent = "A ‚Üí LIFT";
            prompt.style.display = 'block';
        } else if (stairsDown && Math.hypot(stairsDown.x - player.x, stairsDown.y - player.y) < 55) {
            prompt.textContent = "A ‚Üí DOWN";
            prompt.style.display = 'block';
        } else if (stairsUp && Math.hypot(stairsUp.x - player.x, stairsUp.y - player.y) < 55) {
            prompt.textContent = "A ‚Üí UP";
            prompt.style.display = 'block';
        } else if (nearHidingSpot && !player.hidden) {
            prompt.textContent = "A ‚Üí HIDE";
            prompt.style.display = 'block';
        } else if (player.hidden) {
            prompt.textContent = "A ‚Üí COME OUT";
            prompt.style.display = 'block';
        } else if (puzzle && !puzzle.solved && Math.hypot(puzzle.x - player.x, puzzle.y - player.y) < 65) {
            prompt.textContent = "A ‚Üí PUZZLE";
            prompt.style.display = 'block';
        } else if (exitDoor && player.keys >= 5 && Math.hypot(exitDoor.x - player.x, exitDoor.y - player.y) < 90) {
            prompt.textContent = "A ‚Üí ESCAPE!";
            prompt.style.display = 'block';
        }
        
    } catch (e) {
        console.error("Game loop error:", e);
    }
    
    // Continue loop
    if (gameRunning) {
        gameLoopId = requestAnimationFrame(gameLoop);
    }
}

// ============================================
// MODAL FUNCTIONS - PUZZLE DIFFICULTY BASED ON MODE
// ============================================
function openPuzzle() {
    let questions = [];
    
    // Different puzzle difficulties based on game mode
    switch(gameMode) {
        case 'easy':
            questions = [
                {q: "3+4=?", a: "7"},
                {q: "5+6=?", a: "11"},
                {q: "9-3=?", a: "6"},
                {q: "2√ó5=?", a: "10"},
                {q: "8√∑2=?", a: "4"},
                {q: "7+8=?", a: "15"},
                {q: "12-5=?", a: "7"},
                {q: "3√ó4=?", a: "12"}
            ];
            break;
            
        case 'normal':
            questions = [
                {q: "7√ó9=?", a: "63"},
                {q: "15-6=?", a: "9"},
                {q: "25√∑5=?", a: "5"},
                {q: "12+18=?", a: "30"},
                {q: "8√ó8=?", a: "64"},
                {q: "3√ó7=?", a: "21"},
                {q: "14+9=?", a: "23"},
                {q: "36√∑6=?", a: "6"}
            ];
            break;
            
        case 'hard':
            questions = [
                {q: "13√ó7=?", a: "91"},
                {q: "48√∑6=?", a: "8"},
                {q: "17+25=?", a: "42"},
                {q: "63-28=?", a: "35"},
                {q: "9√ó12=?", a: "108"},
                {q: "81√∑9=?", a: "9"},
                {q: "34+47=?", a: "81"},
                {q: "72-36=?", a: "36"}
            ];
            break;
            
        case 'impossible':
            questions = [
                {q: "17√ó13=?", a: "221"},
                {q: "144√∑12=?", a: "12"},
                {q: "89+67=?", a: "156"},
                {q: "125-78=?", a: "47"},
                {q: "15√ó16=?", a: "240"},
                {q: "196√∑14=?", a: "14"},
                {q: "123+89=?", a: "212"},
                {q: "200-123=?", a: "77"}
            ];
            break;
    }
    
    const q = questions[Math.floor(Math.random() * questions.length)];
    document.getElementById('puzzleQuestion').textContent = q.q;
    document.getElementById('puzzleAnswer').value = '';
    document.getElementById('puzzleModal').style.display = 'flex';
    document.getElementById('puzzleAnswer').focus();
    window.currentAnswer = q.a;
}

function closePuzzle() {
    document.getElementById('puzzleModal').style.display = 'none';
}

document.getElementById('submitPuzzle').onclick = () => {
    const answer = document.getElementById('puzzleAnswer').value.trim();
    
    if (answer === window.currentAnswer) {
        puzzle.solved = true;
        puzzlesSolved++;
        closePuzzle();
        
        // Give rewards based on puzzle type
        if (puzzle.rewardType === 'key') {
            player.keys++;
            showAlert("üéâ KEY FOUND! (" + player.keys + "/5)");
        } else if (puzzle.rewardType === 'battery') {
            battery = Math.min(100, battery + puzzle.rewardAmount);
            showAlert("üîã +" + puzzle.rewardAmount + "% BATTERY!");
        } else if (puzzle.rewardType === 'bullets') {
            player.bullets += puzzle.rewardAmount;
            showAlert("üî´ +" + puzzle.rewardAmount + " BULLETS!");
        }
        
        updateUI();
    } else {
        showAlert("‚ùå WRONG ANSWER!");
    }
};

function openLift() {
    const container = document.getElementById('floorButtons');
    container.innerHTML = '';
    
    for (let i = 1; i <= 10; i++) {
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = 'F' + i;
        btn.style.background = i === floor ? '#c00' : '#800';
        btn.style.padding = '6px 4px';
        btn.style.fontSize = i === floor ? '1rem' : '0.9rem';
        btn.onclick = () => {
            closeLift();
            if (i !== floor) changeFloor(i);
        };
        container.appendChild(btn);
    }
    
    document.getElementById('liftModal').style.display = 'flex';
}

function closeLift() {
    document.getElementById('liftModal').style.display = 'none';
}

function changeFloor(to) {
    // Quick fade
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, width, height);
    
    setTimeout(() => {
        initFloor(to);
    }, 300);
}

function showAlert(msg) {
    const alert = document.createElement('div');
    alert.style.cssText = `
        position: fixed;
        top: 40%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(100, 0, 0, 0.9);
        color: #ffd0d0;
        padding: 10px 16px;
        border-radius: 8px;
        border: 2px solid #c00;
        font-size: 1rem;
        z-index: 100000;
        text-align: center;
        max-width: 80%;
        box-shadow: 0 0 20px #800;
        font-family: 'Courier New', monospace;
        backdrop-filter: blur(5px);
    `;
    alert.textContent = msg;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 1500);
}

function gameOver() {
    gameRunning = false;
    showScreen('gameoverScreen');
    
    // Play scare sound
    const scare = document.getElementById('scareSound');
    scare.currentTime = 0;
    scare.play().catch(e => console.log("Scare sound error"));
    
    // Stop music
    document.getElementById('bgm').pause();
}

function winGame() {
    gameRunning = false;
    showScreen('winScreen');
    document.getElementById('bgm').pause();
}

// ============================================
// INITIALIZATION
// ============================================
window.addEventListener('resize', () => {
    width = window.innerWidth;
    height = window.innerHeight;
    canvas.width = width;
    canvas.height = height;
    
    if (player) {
        player.x = Math.min(player.x, width - 60);
        player.y = Math.min(player.y, height - 60);
    }
    
    // Update shoot button position
    updateShootBtnPosition();
});

// Prevent touch behaviors
document.addEventListener('touchmove', function(e) {
    if (e.target === canvas || 
        e.target === joystickArea || 
        e.target === joystick || 
        e.target.closest('#controls')) {
        e.preventDefault();
    }
}, { passive: false });

// Prevent context menu
document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    return false;
});

// Handle back button press (Android)
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' || e.key === 'Backspace') {
        e.preventDefault();
        // If in game screen, go to main menu
        if (document.getElementById('gameScreen').style.display === 'flex') {
            showScreen('startScreen');
        } else {
            exitApp();
        }
    }
});

// Initialize - Start in fullscreen
showScreen('startScreen');
console.log("CURSED APARTMENT - Single Action Button & Hide System");
</script>
</body>
</html>